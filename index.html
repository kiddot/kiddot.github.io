<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Share</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Share">
<meta property="og:url" content="https://kiddot.github.io/index.html">
<meta property="og:site_name" content="Share">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Share">
    

    
        <link rel="alternate" href="/" title="Share" type="application/atom+xml" />
    

    
        <link rel="icon" href="/images/favicon.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Share</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">kiddot</h2>
            <h3 id="title">Android Developer &amp; Coder</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Guangzhou, China</span>
            <a id="follow" target="_blank" href="https://github.com/kiddot">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                25
                <span>文章</span>
            </div>
            <div class="article-info-block">
                5
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/kiddot" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/kiddo1024" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://www.facebook.com/dekai.liang.94" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://dribbble.com/dribbble" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-Android/学习Binder" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/19/Android/学习Binder/" itemprop="url">
            <img src="https://whvn.cc/6596" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/19/Android/学习Binder/">学习Binder</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/19/Android/学习Binder/">
            <time datetime="2017-08-19T02:25:11.000Z" itemprop="datePublished">2017-08-19</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="学习Binder"><a href="#学习Binder" class="headerlink" title="学习Binder"></a>学习Binder</h1><blockquote>
<p>Binder机制的目的<strong>是实现IPC(Inter-Process Communication)，即实现进程间通信</strong>。</p>
</blockquote>
<h2 id="知识储备"><a href="#知识储备" class="headerlink" title="知识储备"></a>知识储备</h2><h3 id="1-Linux系统中内存的划分"><a href="#1-Linux系统中内存的划分" class="headerlink" title="1.Linux系统中内存的划分"></a>1.Linux系统中内存的划分</h3><p>​    在Linux系统中，应用程序都运行在用户空间，而Kernel和驱动都运行在内核空间。用户空间和内核空间若涉及到通信(即数据交互)，两者不能简单地使用指针传递数据，而必须在”内核”中copy_from_user(),copy_to_user(),get_user()或put_user()等函数传递数据。copy_from_user()和get_user()是将内核空间的数据拷贝到用户空间，而copy_to_user()和put_user()则是将用户空间的数据拷贝到内核空间。</p>
<h3 id="2-进程的概念"><a href="#2-进程的概念" class="headerlink" title="2.进程的概念"></a>2.进程的概念</h3><p>​    进程可以说是程序运行在上面的抽象CPU，它拥有独立的内存单位，是系统进行资源分配和调度的基本单位。对Linux系统来说，每个用户空间运行的应用程序都可以看成一个进程。不同进程在不同内存当中。</p>
<h3 id="3-代理模式-远程代理"><a href="#3-代理模式-远程代理" class="headerlink" title="3.代理模式-远程代理"></a>3.代理模式-远程代理</h3><p>​    远程代理是最经典的代理模式之一，远程代理负责与远程JVM通信，以实现本地调用者与远程被调用者之间的正常交互。</p>
<p><img src="http://images.cnitblog.com/blog/610080/201410/042203005033153.jpg" alt="img"></p>
<blockquote>
<p>具体流程是这样的：</p>
<ol>
<li>Client向Stub发送方法调用请求（Client以为Stub就是Server）</li>
<li>Stub接到请求，通过Socket与服务端的Skeleton通信，把调用请求传递给Skeleton</li>
<li>Skeleton接到请求，调用本地Server（听起来有点奇怪，这里Server相当于Service）</li>
<li>Server作出对应动作，把结果返回给调用者Skeleton</li>
<li>Skeleton接到结果之后通过Socket发送给Stub</li>
<li>Stub把结果传递给Client</li>
</ol>
</blockquote>
<h3 id="4-内存映射"><a href="#4-内存映射" class="headerlink" title="4.内存映射"></a>4.内存映射</h3><blockquote>
<p>​    内存映射，简而言之就是将用户空间的一段内存区域映射到内核空间，映射成功后，用户对这段内存区域的修改可以直接反映到内核空间，相反，内核空间对这段区域的修改也直接反映用户空间。那么对于内核空间&lt;—-&gt;用户空间两者之间需要大量数据传输等操作的话效率是非常高的。</p>
</blockquote>
<h2 id="Binder的通信模型"><a href="#Binder的通信模型" class="headerlink" title="Binder的通信模型"></a>Binder的通信模型</h2><p><img src="http://ww1.sinaimg.cn/large/006tKfTcjw1f7adz7zozlj31eq0vowo0.jpg" alt="img"></p>
<p>上图中涉及到Binder模型的4类角色：<strong>Binder驱动</strong>，<strong>ServiceManager</strong>，<strong>Server</strong>和<strong>Client</strong>。</p>
<h3 id="Binder驱动"><a href="#Binder驱动" class="headerlink" title="Binder驱动"></a>Binder驱动</h3><blockquote>
<p>两个不同进程的通信必须要内核进行中转，对于Android而言，在内核中起中转作用便是Binder驱动。</p>
</blockquote>
<p>​    Android的通信是基于Client-Server架构的，进程间的通信无非就是Client向Server发起请求，Server响应Client的请求。这里以发起请求为例：当Client向Server发起请求(例如，MediaPlayer向MediaPlayerService发起请求)，Client会先将请求数据从用户空间拷贝到内核空间(将数据从MediaPlayer发给Binder驱动)；数据被拷贝到内核空间之后，再通过驱动程序，将内核空间中的数据拷贝到Server位于用户空间的缓存中(Binder驱动将数据发给MediaPlayerService)。这样，就成功的将Client进程中的请求数据传递到了Server进程中。</p>
<p>​    实际上，Binder驱动是整个Binder机制的核心。除了实现上面所说的数据传输之外，Binder驱动还是实现线程控制(通过中断等待队列实现线程的等待/唤醒)，以及UID/PID等安全机制的保证。</p>
<h3 id="ServiceManager"><a href="#ServiceManager" class="headerlink" title="ServiceManager"></a>ServiceManager</h3><blockquote>
<p>​    Binder是要实现Android的C-S架构的，即Client-Server架构。而ServiceManager，是以服务管理者的身份存在的。ServiceManager也是运行在用户空间的一个独立进程。</p>
</blockquote>
<p>​    对于Binder驱动而言，<strong>ServiceManager是一个守护进程，更是Android系统各个服务的管理者</strong>。Android系统中的各个服务，都是添加到ServiceManager中进行管理的，而且每个服务都对应一个服务名。当Client获取某个服务时，则<strong>通过服务名</strong>来从ServiceManager中获取相应的服务。</p>
<p>​     对于MediaPlayerService和MediaPlayer而言，<strong>ServiceManager是一个Server服务端，是一个服务器</strong>。当要将MediaPlayerService等服务添加到ServiceManager中进行管理时，ServiceManager是服务器，它会收到MediaPlayerService进程的添加服务请求。当MediaPlayer等客户端要获取MediaPlayerService等服务时，它会向ServiceManager发起获取服务请求。</p>
<p>​    当MediaPlayer和MediaPlayerService通信时，MediaPlayerService是服务端；而当MediaPlayerService与ServiceManager通信时，ServiceManager则是服务端。这样，就造就了ServiceManager的特殊性。于是，在Binder驱动中，将句柄0指定为ServiceManager对应的句柄，通过这个特殊的句柄就能获取ServiceManager对象。</p>
<h3 id="Client、Server"><a href="#Client、Server" class="headerlink" title="Client、Server"></a>Client、Server</h3><blockquote>
<p>​    这两个便是要进行通信的两个不同进程，比如MediaPlayerService和MediaPlayer</p>
</blockquote>
<h2 id="为什么选择Binder"><a href="#为什么选择Binder" class="headerlink" title="为什么选择Binder"></a>为什么选择Binder</h2><blockquote>
<p>​    Android是在Linux内核的基础上设计的。但是在Linux中，拥有”<strong>管道</strong>/<strong>消息队列</strong>/<strong>共享内存</strong>/<strong>信号量</strong>/<strong>Socket</strong>等等”众多的IPC通信手段。为什么不选择其它的IPC通信方式，而要设计出Binder？</p>
</blockquote>
<h3 id="1-从传输效率上看，Binder更能实现C-S架构"><a href="#1-从传输效率上看，Binder更能实现C-S架构" class="headerlink" title="1.从传输效率上看，Binder更能实现C-S架构"></a>1.从传输效率上看，Binder更能实现C-S架构</h3><p>​    Linux支持的”传统的管道/消息队列/共享内存/信号量/Socket等”IPC通信手段中，只有Socket是Client-Server的通信方式。<strong>但是</strong> ， socket作为一款通用接口，其传输效率低，开销大，主要用在跨网络的进程间通信和本机上进程间的低速通信。</p>
<h3 id="2-从传输效率和可操作性上看"><a href="#2-从传输效率和可操作性上看" class="headerlink" title="2.从传输效率和可操作性上看"></a>2.从传输效率和可操作性上看</h3><blockquote>
<p>​    <strong>管道，消息队列</strong>采用存储-转发方式，即数据先从发送方缓存区拷贝到内核开辟的缓存区中，然后再从内核缓存区拷贝到接收方缓存区，至少有两次拷贝过程。<strong>效率太低！</strong></p>
<p>​    对于<strong>共享内存</strong>来说，虽然使用它进行IPC通信时进行的内存拷贝次数是0。但是，共享内存操作复杂，并不适合用。</p>
</blockquote>
<p>​    采用Binder机制的话，则只需要经过<strong>1次</strong>内存拷贝即可！ 即，从发送方的缓存区拷贝到内核的缓存区，而接收方的缓存区与内核的缓存区是映射到同一块物理地址的（内存映射），因此只需要1次拷贝即可。</p>
<h3 id="从安全性来看，Binder更安全"><a href="#从安全性来看，Binder更安全" class="headerlink" title="从安全性来看，Binder更安全"></a>从安全性来看，Binder更安全</h3><blockquote>
<p>​    传统IPC没有任何安全措施，完全依赖上层协议来确保。传统IPC的接收方无法获得对方进程可靠的UID/PID(用户ID/进程ID)，从而无法鉴别对方身份。而Binder机制则为每个进程分配了UID/PID来作为鉴别身份的标示，并且在Binder通信时会根据UID/PID进行有效性检测。</p>
</blockquote>
<h2 id="Binder中的各个联系"><a href="#Binder中的各个联系" class="headerlink" title="Binder中的各个联系"></a>Binder中的各个联系</h2><p><img src="https://raw.githubusercontent.com/wangkuiwu/android_applets/master/os/pic/binder/binder_4relationship.jpg" alt="img"></p>
<h3 id="重要概念说明"><a href="#重要概念说明" class="headerlink" title="重要概念说明"></a>重要概念说明</h3><h4 id="1-Binder实体"><a href="#1-Binder实体" class="headerlink" title="1.Binder实体"></a>1.Binder实体</h4><blockquote>
<p>Binder实体，是各个Server以及ServiceManager在内核中的存在形式。</p>
</blockquote>
<p>​    Binder实体实际上是内核中binder_node结构体的对象，它的作用是在内核中保存Server和ServiceManager的信息(例如，Binder实体中保存了Server对象在用户空间的地址)。简言之，Binder实体是Server在Binder驱动中的存在形式，内核通过Binder实体可以找到用户空间的Server对象。</p>
<p>​    在上图中，Server和ServiceManager在Binder驱动中都对应的存在一个Binder实体。</p>
<h4 id="2-Binder引用"><a href="#2-Binder引用" class="headerlink" title="2.Binder引用"></a>2.Binder引用</h4><blockquote>
<p>所谓Binder引用，实际上是内核中binder_ref结构体的对象，它的作用是在表示”Binder实体”的引用。</p>
</blockquote>
<p>​    每一个Binder引用都是某一个Binder实体的引用，通过Binder引用可以在内核中找到它对应的Binder实体。如果将Server看作是Binder实体的话，那么Client就好比Binder引用。Client要和Server通信，它就是通过保存一个Server对象的Binder引用，再通过该Binder引用在内核中找到对应的Binder实体，进而找到Server对象，然后将通信内容发送给Server对象。</p>
<p>​    Binder实体和Binder引用都是内核(即，Binder驱动)中的数据结构。每一个Server在内核中就表现为一个Binder实体，而每一个Client则表现为一个Binder引用。这样，每个Binder引用都对应一个Binder实体，而每个Binder实体则可以多个Binder引用。</p>
<h4 id="3-远程服务"><a href="#3-远程服务" class="headerlink" title="3.远程服务"></a>3.远程服务</h4><p>​    Server都是以服务的形式注册到ServiceManager中进行管理的。如果将Server本身看作是”本地服务”的话，那么Client中的”远程服务”就是本地服务的代理。远程服务就是本地服务的一个代理，通过该远程服务Client就能和Server进行通信。</p>
<h3 id="简要流程分析"><a href="#简要流程分析" class="headerlink" title="简要流程分析"></a>简要流程分析</h3><h4 id="ServiceManager守护进程"><a href="#ServiceManager守护进程" class="headerlink" title="ServiceManager守护进程"></a>ServiceManager守护进程</h4><p>​    ServiceManager是用户空间的一个守护进程。当该应用程序启动时，它会和Binder驱动进行通信，告诉Binder驱动它是服务管理者；对Binder驱动而言，它则会新建ServiceManager对应的Binder实体，并将该Binder实体设为全局变量。</p>
<p>​    为什么要将它设为全局变量呢？因为Client和Server都需和ServiceManager进行通信，不将它设为全局变量的话，无法找到ServiceManager</p>
<h4 id="Server注册到ServiceManager"><a href="#Server注册到ServiceManager" class="headerlink" title="Server注册到ServiceManager"></a>Server注册到ServiceManager</h4><p>​    Server首先会向Binder驱动发起注册请求，而Binder驱动在收到该请求之后就将该请求转发给ServiceManager进程。但是Binder驱动怎么才能知道该请求是要转发给ServiceManager的呢？这是因为Server在发送请求的时候，会告诉Binder驱动这个请求是交给0号Binder引用对应的进程来进行处理的。而Binder驱动中指定了0号引用是与ServiceManager对应的。</p>
<p>​    在Binder驱动转发该请求之前，它其实还做了两件很重要的事：</p>
<blockquote>
<p><strong>(01) 当它知道该请求是由一个Server发送的时候，它会新建该Server对应的Binder实体。</strong></p>
<p><strong>(02) 它在ServiceManager的”保存Binder引用的红黑树”中查找是否存在该Server的Binder引用；找不到的话，就新建该Server对应的Binder引用，并将其添加到”ServiceManager的保存Binder引用的红黑树”中。</strong></p>
</blockquote>
<p>​    当ServiceManager收到Binder驱动转发的注册请求之后，它就将该Server的相关信息注册到”Binder引用组成的单链表”中。这里所说的Server相关信息主要包括两部分：<strong>Server对应的服务名</strong> + <strong>Server对应的Binder实体的一个Binder引用</strong>。</p>
<h4 id="Client获取远程服务"><a href="#Client获取远程服务" class="headerlink" title="Client获取远程服务"></a>Client获取远程服务</h4><blockquote>
<p>Client要和某个Server通信，需要先获取到该Server的远程服务。</p>
</blockquote>
<p>​    Client首先会向Binder驱动发起获取服务的请求。Binder驱动在收到该请求之后也是该请求转发给ServiceManager进程。ServiceManager在收到Binder驱动转发的请求之后，会从”Binder引用组成的单链表”中找到要获取的Server的相关信息。</p>
<p>​    至于ServiceManager是如何从单链表中找到需要的Server的呢？答案是Client发送的请求数据中，会包括它要获取的Server的服务名；而ServiceManager正是根据这个<strong>服务名</strong>来找到Server的。</p>
<p>​    接下来，ServiceManager通过Binder驱动将Server信息反馈给Client的。它反馈的信息是Server对应的Binder实体的Binder引用信息。而Client在收到该Server的Binder引用信息之后，就根据该Binder引用信息创建一个Server对应的远程服务。这个远程服务就是Server的代理，Client通过调用该远程服务的接口，就相当于在调用Server的服务接口一样；因为Client调用该Server的远程服务接口时，该远程服务会对应的通过Binder驱动和真正的Server进行交互，从而执行相应的动作。</p>
<h2 id="Binder的设计"><a href="#Binder的设计" class="headerlink" title="Binder的设计"></a>Binder的设计</h2><blockquote>
<p>通过上面，已经有了Binder模型的理论基础。现在开始学习它的设计思路。</p>
</blockquote>
<h3 id="两个中心思想"><a href="#两个中心思想" class="headerlink" title="两个中心思想"></a>两个中心思想</h3><h4 id="一、Server提供接入点"><a href="#一、Server提供接入点" class="headerlink" title="一、Server提供接入点"></a>一、Server提供接入点</h4><blockquote>
<p>​    如果C-S架构中的Client和Server属于同一进程的话，那么Client和Server之间的通信将非常容易。只需要在Client端先获取相应的Server端对象；然后，再通过Server对象调用Server的相应接口即可。但是，Binder机制中涉及到的Client和Server是位于不同的进程中的，这也就意味着，不可能直接获取到Server对象。<strong>那就需要Server提供一个接入点给Client。</strong></p>
<p><strong>而</strong>这个接入点就是<strong>“Server的远程服务代理”</strong>！</p>
</blockquote>
<p>​    Client能够获取到Server的远程服务，它就相当于Server的代理。Client要和Server通信时，它只需要调用该远程服务的相应接口即可，其他的工作都交给远程服务来处理。远程服务收到Client请求之后，会和Binder驱动通信；因为远程服务中有Server在Binder驱动中的Binder引用信息，因此远程服务就能轻易的找到对应的Server，进而将Client的请求内容发送Server。</p>
<h4 id="二、通信协议"><a href="#二、通信协议" class="headerlink" title="二、通信协议"></a>二、通信协议</h4><blockquote>
<p>Binder机制中，涉及到大量的”内核的Binder驱动 和 用户空间的引用程序”之间的通信。需要指定对应的通信协议，确保通信的安全和正常。</p>
</blockquote>
<h3 id="内核空间的设计"><a href="#内核空间的设计" class="headerlink" title="内核空间的设计"></a>内核空间的设计</h3><blockquote>
<p>​    内核空间的Binder设计涉及到3个非常重要的结构体：binder_proc，binder_node和binder_ref。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">binder_proc</th>
<th style="text-align:center">描述进程上下文信息的，每一个用户空间的进程都对应一个binder_proc结构体。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">binder_node</td>
<td style="text-align:center">Binder实体对应的结构体，它是Server在Binder驱动中的体现</td>
</tr>
<tr>
<td style="text-align:center">binder_ref</td>
<td style="text-align:center">Binder引用对应的结构体，它是Client在Binder驱动中的体现</td>
</tr>
</tbody>
</table>
<p><img src="https://raw.githubusercontent.com/wangkuiwu/android_applets/master/os/pic/binder/binder_kernel_ds01.jpg" alt="img"></p>
<p>如上图所示，binder_proc中包含了3棵红黑树。<br>​    (01) Binder实体红黑树是保存”binder_proc对应的进程”所包含的Binder实体的，而Binder实体是与Server的服务对应的。可以将Binder实体红黑树理解为Server进程中包行的Server服务的红黑树。<br>​    (02) 图中有两棵Binder引用红黑树，这两棵树所包含的Binder引用都是一样的。不同的是，红黑树的排序基准不同，一个是以Binder实体来排序，而另一个则是以Binder引用描述(Binder引用描述实际上就是一个32位的整型数)来排序。以Binder引用描述的红黑树是为了方便进行快速查找。</p>
<p><img src="https://raw.githubusercontent.com/wangkuiwu/android_applets/master/os/pic/binder/binder_kernel_ds02.jpg" alt="img"></p>
<p>​    上图是描述Binder驱动中Binder实体结构体的。如图所示，Binder实体中有一个Binder引用的哈希表，专门来存放该Binder实体的Binder引用。这也如我们之前所说，每个Binder实体则可以多个Binder引用，而每个Binder引用则都只对应一个Binder实体。</p>
<h3 id="用户空间的Binder设计"><a href="#用户空间的Binder设计" class="headerlink" title="用户空间的Binder设计"></a>用户空间的Binder设计</h3><p><img src="https://raw.githubusercontent.com/wangkuiwu/android_applets/master/os/pic/binder/binder_user_ds01.jpg" alt="img"></p>
<blockquote>
<p>​    Server是以服务的形式注册到ServiceManager中，而Server在Client中则是以远程服务的形式存在的。因此，这个图的主干就是理清楚本地服务和远程服务这两者之间的关系。</p>
</blockquote>
<p>​    “本地服务”就是Server提供的服务本身，而”远程服务”就是服务的代理；”服务接口”则是抽象出了它们的通用接口。这3个角色都是通用的，对于不同的服务而言，它们的名称都不相同。例如，对于MediaPlayerService服务而言，本地服务就是MediaPlayerService自身，远程服务是BpMediaPlayerService，而服务接口是IMediaPlayerService。当Client需要向MediaPlayerService发送请求时，它需要先获取到服务的代理(即，远程服务对象)，也就是BpMediaPlayerService实例，然后通过该实例和MediaPlayerService进行通信。</p>
<p>图中的ProcessState和IPCThreadState都是采用单例模式实现的，它们的实例都是全局的，而且只有唯一一个。</p>
<p>​    (01) 当Server启动之后，它会先将自己注册到ServiceManager中。注册时，Binder驱动会创建Server对应的Binder实体，并将”Server对应的本地服务对象的地址”保存到Binder实体中。注册成功之后，Server就进入消息循环，等待Client的请求。<br>​    (02) 当Client需要和Server通信时，会先获取到Server接入点，即获取到远程服务对象；而且Client要获取的远程服务对象是”服务接口”类型的。Client向ServiceManager发送获取服务的请求时，会通过IPCThreadState和Binder驱动进行通信；当ServiceManager反馈之后，IPCThreadState会将ServiceManager反馈的”Server的Binder引用信息”保存BpBinder中(具体来说，BpBinder的mHandle成员保存的就是Server的Binder引用信息)。然后，会根据该BpBinder对象创建对应的远程服务。这样，Client就获取到了远程服务对象，而且远程服务对象的成员中保存了Server的Binder引用信息。<br>​    (03) 当Client获取到远程服务对象之后，它就可以轻松的和Server进行通信了。当它需要向Server发送请求时，它会调用远程服务接口；远程服务能够获取到BpBinder对象，而BpBinder则通过IPCThreadState和Binder驱动进行通信。由于BpBinder中保存了Server在Binder驱动中的Binder引用；因此，IPCThreadState和Binder驱动通信时，是知道该请求是需要传给哪个Server的。Binder驱动通过Binder引用找到对应的Binder实体，然后将Binder实体中保存的”Server对应的本地服务对象的地址”返回给用户空间。当IPC收到Binder驱动反馈的内容之后，它从内容中找到”Server对应的本地服务对象”，然后调用该对象的onTransact()。不同的本地服务都可以实现自己的onTransact()；这样，不同的服务就可以按照自己的需求来处理请求。</p>
<p>### </p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/19/Android/学习Binder/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/19/Android/学习Binder/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/项目组件化" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/16/Android/项目组件化/" itemprop="url">
            <img src="https://whvn.cc/6585" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/16/Android/项目组件化/">项目组件化流程</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/16/Android/项目组件化/">
            <time datetime="2017-08-16T02:22:11.000Z" itemprop="datePublished">2017-08-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="项目组件化"><a href="#项目组件化" class="headerlink" title="项目组件化"></a>项目组件化</h1><blockquote>
<p>什么是组件化开发？就是将一个app分成多个模块，每个模块都是一个组件（Module），开发的过程中我们可以让这些组件相互依赖或者单独调试部分组件等，但是最终发布的时候是将这些组件合并统一成一个apk，这就是组件化开发。</p>
</blockquote>
<h2 id="为什么要组件化开发？"><a href="#为什么要组件化开发？" class="headerlink" title="为什么要组件化开发？"></a>为什么要组件化开发？</h2><p>比较常见的架构都是一个界面就存在大量的业务逻辑，而业务逻辑中又有各种网络请求以及数据操作等，整个项目没有模块的概念，基本都是以业务逻辑划分文件夹来进行开发，这样的做法最大的缺点就是业务之间会比较容易产生耦合。</p>
<p><img src="http://img.blog.csdn.net/20170522210912111?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VpeWluZzcxMg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="单一工程模型下的业务关系"></p>
<p>随着产品版本的迭代，业务越来越复杂之后，带来的问题会更明显：</p>
<ul>
<li><ol>
<li>单一工程业务逻辑耦合度太高，容易改动一个地方会牵扯到其它本不应该相关的业务逻辑。</li>
<li>随着工程越来越大，编译的时间会越来越久。</li>
<li>团队协作开发会存在较多的冲突。</li>
<li>不能灵活的对工程进行配置和组装.比如今天产品经理说加上这个功能,明天又说去掉,后天在加上.</li>
</ol>
</li>
</ul>
<h2 id="什么是组件化开发"><a href="#什么是组件化开发" class="headerlink" title="什么是组件化开发"></a>什么是组件化开发</h2><p>在单工程模型的基础上，将业务层中的各业务抽取出来，封装成响应的业务组件，将基础库的各部分抽取，封装成基础组件，而主工程就是一个可运行的app，作为各组件的入口。业务组件在组件模式下可以独立开发，而在集成模式下又可以变为arr包集成到“app壳工程”中，组成一个完整功能的APP</p>
<p><img src="http://oeu3kvs3k.bkt.clouddn.com/2017-10-14%2015-15-24%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" alt="组件化工程模型"></p>
<p>上图是组件化工程模型，下面是组件化工程中用到的名词的含义：</p>
<table>
<thead>
<tr>
<th style="text-align:center">名词</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">集成模式</td>
<td style="text-align:center">所有的业务组件被“app壳工程”依赖，组成一个完整的APP；</td>
</tr>
<tr>
<td style="text-align:center">组件模式</td>
<td style="text-align:center">可以独立开发业务组件，每一个业务组件就是一个APP；</td>
</tr>
<tr>
<td style="text-align:center">app壳工程</td>
<td style="text-align:center">负责管理各个业务组件，和打包apk，没有具体的业务功能；</td>
</tr>
<tr>
<td style="text-align:center">业务组件</td>
<td style="text-align:center">根据公司具体业务而独立形成一个的工程；</td>
</tr>
<tr>
<td style="text-align:center">功能组件</td>
<td style="text-align:center">提供开发APP的某些基础功能，例如打印日志、树状图等；</td>
</tr>
<tr>
<td style="text-align:center">Main组件</td>
<td style="text-align:center">属于业务组件，指定APP启动页面、主界面；</td>
</tr>
<tr>
<td style="text-align:center">Common组件</td>
<td style="text-align:center">属于功能组件，支撑业务组件的基础，提供多数业务组件需要的功能，例如提供网络请求功能；</td>
</tr>
</tbody>
</table>
<p>组件化工程模型中，看似业务组件之间相对是独立的，但实际开发中多少会有些情况需要组件之间相互通信，那么这如果处理不好可能会带来一些依赖关系变得十分复杂的情况，甚至会出现一些潜在的风险，但是这种模型带来的好处还是十分明显的：</p>
<ul>
<li>1.加快业务的迭代速度，各业务模块更加独立。</li>
<li>2.加快编译速度，提高开发效率</li>
<li>3.降低团队成员熟悉项目成本，降低项目维护难度</li>
</ul>
<h2 id="组件化具体流程"><a href="#组件化具体流程" class="headerlink" title="组件化具体流程"></a>组件化具体流程</h2><h3 id="1-第一步：配置可自动将组件在Application和Library属性之间切换"><a href="#1-第一步：配置可自动将组件在Application和Library属性之间切换" class="headerlink" title="1.第一步：配置可自动将组件在Application和Library属性之间切换"></a>1.第一步：配置可自动将组件在Application和Library属性之间切换</h3><p>在Android studio中的Module主要有两种属性，分别为：</p>
<ul>
<li>Application属性，可以独立运行android程序<ul>
<li>apply plugin: ‘com.android.application’</li>
</ul>
</li>
<li>library属性：不可以独立运行，一般是android程序依赖的库文件<ul>
<li>apply plugin: ‘com.android.library’</li>
</ul>
</li>
</ul>
<p>当我们在开发单独组件的时候，这个组件应该处于application模式，而当我们要将单独组件合并到主工程的时候，就需要将单独组从application模式改为library模式。为了做到一次修改，全局组件生效。在Android Studio项目的根目录下有一个gradle.properties 文件，这个文件主要用来配置Gradle settings。在这里gradle.properties添加了一行代码，定义一个属性isModule（是否是组件开发模式，true为是，false为否）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isModule.toBoolean()) &#123;    </span><br><span class="line">        apply plugin: <span class="string">'com.android.application'</span>&#125; </span><br><span class="line">          <span class="keyword">else</span> &#123;   </span><br><span class="line">               apply plugin: <span class="string">'com.android.library'</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-第二步：解决组件AndroidManifest和主工程AndroidManifest合并问题"><a href="#2-第二步：解决组件AndroidManifest和主工程AndroidManifest合并问题" class="headerlink" title="2.第二步：解决组件AndroidManifest和主工程AndroidManifest合并问题"></a>2.第二步：解决组件AndroidManifest和主工程AndroidManifest合并问题</h3><blockquote>
<p>每个组件是由不同的成员单独开发的，这个时候组件就是一个独立的APP，那么这个组件就会有自己的“AndroidManifest.xml”，但是Android程序只有一个“AndroidManifest.xml”，当我们要把组件作为Library合并到主工程的时候，组件的“AndroidManifest.xml”和主工程的“AndroidManifest.xml”就会产生冲突，因为他们都有自己实现application类以及一些属性，还有自己的MAIN Activity，如果直接把张表合并到一起势必产生冲突。</p>
</blockquote>
<p>解决思路就是：每个组件维护两张表，一张用于组件单独开发时使用，另一张用于合并到主工程的注册表中，每当增加一个Android系统的四大组件时都要同时给两张表中添加。</p>
<ul>
<li>首先在组件的main文件夹（和java文件夹平级）下创建两个文件夹:</li>
</ul>
<p><img src="http://img2.100weidu.com/get?src=http://mmbiz.qpic.cn/mmbiz_png/ibuh47bPhianYAq9uhkSyKMlABUJVc2ypNKc7TqYdxP4bibzJJ1IVIzWK3iammtK9wyDkrqK5AnuicNuAGd4vCEuXhA/0?wx_fmt=png" alt="img"></p>
<ul>
<li><p>然后在每个组件的<em>build.gradle</em>中添加如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;        </span><br><span class="line">            <span class="keyword">if</span> (isModule.toBoolean()) &#123;</span><br><span class="line">            manifest.srcFile <span class="string">'src/main/debug/AndroidManifest.xml'</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            manifest.srcFile <span class="string">'src/main/release/AndroidManifest.xml'</span></span><br><span class="line">            <span class="comment">//release模式下排除debug文件夹中的所有Java文件</span></span><br><span class="line">            java &#123;</span><br><span class="line">                exclude <span class="string">'debug/**'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这些代码的意思是：当在组件开发模式下，组件的注册表文件使用debug文件夹下的，其他情况使用release文件夹下的注册表文件；那么这两张表的区别在哪里？</p>
<p>下面表示debug文件夹中的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;application</span><br><span class="line">    android:name=<span class="string">"debug.CarApplication"</span></span><br><span class="line">    android:icon=<span class="string">"@mipmap/ic_car_launcher"</span></span><br><span class="line">    android:label=<span class="string">"@string/car_name"</span></span><br><span class="line">    android:supportsRtl=<span class="string">"true"</span></span><br><span class="line">    android:theme=<span class="string">"@style/AppTheme"</span>&gt;</span><br><span class="line">    &lt;activity</span><br><span class="line">        android:name=<span class="string">".query.QueryActivity"</span></span><br><span class="line">        android:configChanges=<span class="string">"orientation|screenSize|keyboard"</span></span><br><span class="line">        android:screenOrientation=<span class="string">"portrait"</span></span><br><span class="line">        android:windowSoftInputMode=<span class="string">"adjustPan|stateHidden"</span>&gt;</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">            &lt;action android:name=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span><br><span class="line"></span><br><span class="line">            &lt;category android:name=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span><br><span class="line">        intent-filter&gt;</span><br><span class="line">    activity&gt;</span><br><span class="line">    &lt;activity</span><br><span class="line">        android:name=<span class="string">".scan.ScanActivity"</span></span><br><span class="line">        android:screenOrientation=<span class="string">"portrait"</span> /&gt;</span><br><span class="line">application&gt;</span><br></pre></td></tr></table></figure>
<p>下面是release文件夹中的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> &lt;application android:theme=<span class="string">"@style/AppTheme"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;activity</span><br><span class="line">        android:name=<span class="string">".query.QueryActivity"</span></span><br><span class="line">        android:configChanges=<span class="string">"orientation|screenSize|keyboard"</span></span><br><span class="line">        android:screenOrientation=<span class="string">"portrait"</span></span><br><span class="line">        android:theme=<span class="string">"@style/AppTheme"</span></span><br><span class="line">        android:windowSoftInputMode=<span class="string">"adjustPan|stateHidden"</span> /&gt;</span><br><span class="line">    &lt;activity</span><br><span class="line">        android:name=<span class="string">".scan.ScanActivity"</span></span><br><span class="line">        android:screenOrientation=<span class="string">"portrait"</span> /&gt;</span><br><span class="line">application&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li>debug文件夹中注册表的标签中指定了具体application类，而release文件夹中的则没有，</li>
<li>debug文件夹中注册表的标签中添加一些application属性，而release文件夹中的则什么都没有添加；</li>
<li>debug文件夹中的注册表指定QueryActivity为MAIN Activity，也就是要启动的 Activity，而release文件夹中的则没有；</li>
</ol>
<h3 id="3-第三步：解决组件和主工程的Application冲突问题以及组件单独开发初始化数据问题"><a href="#3-第三步：解决组件和主工程的Application冲突问题以及组件单独开发初始化数据问题" class="headerlink" title="3.第三步：解决组件和主工程的Application冲突问题以及组件单独开发初始化数据问题"></a>3.第三步：解决组件和主工程的Application冲突问题以及组件单独开发初始化数据问题</h3><blockquote>
<p>当android程序启动时，android系统会为每个程序创建一个Application类的对象，并且只创建一个，application对象的生命周期是整个程序中最长的，它的生命周期就等于这个程序的生命周期。在默认情况下应用系统会自动生成Application 对象，但是如果我们自定义了Application，那就需要告知系统，实例化的时候，是实例化我们自定义的，而非默认的。</p>
</blockquote>
<p>Q:我们在组件化开发的时候每一个组件可能都会有一个自己的Application类的对象，如果我们在自己的组件中开发时需要获取全局的Context，一般都会直接获取application对象，但是当所有组件要打包合并在一起的时候就会出现问题，因为最后程序只有一个Application，我们组件中自己定义的Application肯定没法使用</p>
<p>A:首先创建一个叫做Common的Library，这个Common库中主要包含整个项目用到公共基类、工具类、自定义View等，例如BaseActivity、BaseFragment、BaseApplication等，并且我们的每一个组件都要依赖这个Common库，现在主要讲Common库中的BaseApplication怎么定义，下面是BaseApplication中的部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;        </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> BaseApplication sInstance;        </span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> Context context;        </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BaseApplication <span class="title">getIns</span><span class="params">()</span> </span>&#123;            </span><br><span class="line">                <span class="keyword">return</span> sInstance;</span><br><span class="line">     &#125;        </span><br><span class="line">       </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;           </span><br><span class="line">             <span class="keyword">super</span>.onCreate();</span><br><span class="line">         sInstance = <span class="keyword">this</span>;</span><br><span class="line">         context = <span class="keyword">this</span>.getApplicationContext();            </span><br><span class="line">             <span class="keyword">if</span> (isAppDebug(context)) &#123;    <span class="comment">//只有debug模式才会打印日志</span></span><br><span class="line">             Logger.init(<span class="string">"Demo"</span>).logLevel(LogLevel.FULL);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             Logger.init(<span class="string">"Demo"</span>).logLevel(LogLevel.NONE);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>因为每个组件都依赖了Common库，所以每个组件都能够获取到BaseApplication.context，但是Android程序默认的是系统自己的Application这个类，要想使用自己的就要继承Application并且在AndroidManifest.xml中声明，因此我们先在自己的组件中创建一个组件Application并且继承于BaseApplication，然后在debug文件中的AndroidManifest.xml中声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>&#123;    </span><br><span class="line">    </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;        </span><br><span class="line">            <span class="keyword">super</span>.onCreate();</span><br><span class="line">        login();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们就可以在组件中使用全局的Context：BaseApplication.context了，但是还有一个问题，我们在自己的组件中定义了CarApplication，那么组件合并到主工程后，主工程也有自己的Application，这样又冲突了。一个解决思路跟上面类似，合并的时候排除掉就可以了，主要做法如下：</p>
<p><img src="http://img2.100weidu.com/get?src=http://mmbiz.qpic.cn/mmbiz_png/ibuh47bPhianYAq9uhkSyKMlABUJVc2ypNWwFFsaicic7zyjbGIYpp4wI4vfpr4Y4ialdYEIhyDnBQ4TLwt6L4uLtgA/0?wx_fmt=png" alt="img"></p>
<p>我们在java文件夹下再建一个debug文件夹，把组件自己的application放在这个文件夹中，然后在build.gradle添加这行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;        </span><br><span class="line">            <span class="keyword">if</span> (isModule.toBoolean()) &#123;</span><br><span class="line">            manifest.srcFile <span class="string">'src/main/debug/AndroidManifest.xml'</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            manifest.srcFile <span class="string">'src/main/release/AndroidManifest.xml'</span></span><br><span class="line">            <span class="comment">//release模式下排除debug文件夹中的所有Java文件</span></span><br><span class="line">            java &#123;</span><br><span class="line">                exclude <span class="string">'debug/**'</span><span class="comment">//增加这里的代码</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在合并到主项目时debug文件夹下的java文件就全部被排除了。并且你可以在组件的Application中做一些初始化的操作，比如登陆，然后把数据保存下来，供组件使用。</p>
<h3 id="4-第四步：解决library重复依赖以及SDK和依赖的第三方库版本号控制问题"><a href="#4-第四步：解决library重复依赖以及SDK和依赖的第三方库版本号控制问题" class="headerlink" title="4.第四步：解决library重复依赖以及SDK和依赖的第三方库版本号控制问题"></a>4.第四步：解决library重复依赖以及SDK和依赖的第三方库版本号控制问题</h3><blockquote>
<p>重复依赖问题其实在开发中经常会遇到，比如你 compile 了一个A，然后在这个库里面又 compile 了一个B，然后你的工程中又 compile 了一个同样的B，就依赖了两次。 </p>
</blockquote>
<p>默认情况下，如果是 aar 依赖，gradle 会自动帮我们找出新版本的库而抛弃旧版本的重复依赖。但是如果你使用的是 project 依赖，gradle 并不会去去重，最后打包就会出现代码中有重复的类了。</p>
<p><strong>Library重复依赖的解决办法就是给整个工程提供统一的依赖第三方库的入口</strong>,可以建立一个Common库，这个库还有一个作用就是用来为整个项目提供统一的依赖第三方库的入口，我们把项目常用或者必须用到的库全部在Common库的build.gradle中依赖进来，例如Android support Library、网络库、图片加载库等，又因为每个组件都要依赖这个Common库，所以的build.gradle中就不在需要依赖任何其他库了，这样我们就有了统一的依赖第三方库的入口，添加、删除和升级库文件都只需要在Common库中去处理就好了。</p>
<hr>
<p>另外一个问题就是我们每个组件的build.gradle中都要配置一些属性，例如compileSdkVersion、buildToolsVersion还有defaultConfig等，如果我们需要修改项目的compileSdkVersion版本号，那就麻烦了，因为将会有很多组的build.gradle。所以要把这些build.gradle中都要配置的属性统一起来，类似于java中的静态常量，一处修改到处生效。在项目的build.gradle中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define versions in a single place</span></span><br><span class="line"></span><br><span class="line">ext &#123;<span class="comment">// Sdk and tools</span></span><br><span class="line"> </span><br><span class="line">    buildToolsVersion = localBuildToolsVersion</span><br><span class="line">    compileSdkVersion = <span class="number">23</span></span><br><span class="line"> </span><br><span class="line">    minSdkVersion = <span class="number">16</span></span><br><span class="line"> </span><br><span class="line">    targetSdkVersion = <span class="number">23</span><span class="comment">//时间：2017.2.13；每次修改版本号都要添加修改时间</span></span><br><span class="line"></span><br><span class="line">    versionCode = <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    versionName = <span class="string">"1.0"</span></span><br><span class="line"></span><br><span class="line">    javaVersion = JavaVersion.VERSION_1_8</span><br><span class="line">    / App dependencies version</span><br><span class="line">        </span><br><span class="line">     supportLibraryVersion = <span class="string">"23.2.1"</span></span><br><span class="line"></span><br><span class="line">        retrofitVersion = <span class="string">"2.1.0"</span></span><br><span class="line"></span><br><span class="line">        glideVersion = <span class="string">"3.7.0"</span></span><br><span class="line"></span><br><span class="line">        loggerVersion = <span class="string">"1.15"</span></span><br><span class="line"></span><br><span class="line">        eventbusVersion = <span class="string">"3.0.0"</span></span><br><span class="line"></span><br><span class="line">        gsonVersion = <span class="string">"2.8.0"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>然后在组件的build.gradle中引用这些值，下面是Common库的build.gradle代码会和组件的build.gradle有些许差异：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.library'</span>android &#123;    </span><br><span class="line">compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">    buildToolsVersion rootProject.ext.buildToolsVersion</span><br><span class="line"></span><br><span class="line">defaultConfig &#123;    </span><br><span class="line">      minSdkVersion rootProject.ext.minSdkVersion</span><br><span class="line">    targetSdkVersion rootProject.ext.targetSdkVersion</span><br><span class="line">    versionCode rootProject.ext.versionCode</span><br><span class="line">    versionName rootProject.ext.versionName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buildTypes &#123;    </span><br><span class="line">      release &#123;        </span><br><span class="line">            minifyEnabled <span class="keyword">false</span></span><br><span class="line">        <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">dependencies </span>&#123;    </span><br><span class="line">      <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></span><br><span class="line"><span class="function">    <span class="comment">//Android Support</span></span></span><br><span class="line"><span class="function">    compile "com.android.support:appcompat-v7:$rootProject.supportLibraryVersion"</span></span><br><span class="line"><span class="function">    compile "com.android.support:design:$rootProject.supportLibraryVersion"</span></span><br><span class="line"><span class="function">    compile "com.android.support:percent:$rootProject.supportLibraryVersion"</span></span><br><span class="line"><span class="function">    <span class="comment">//网络请求相关</span></span></span><br><span class="line"><span class="function">    compile "com.squareup.retrofit2:retrofit:$rootProject.retrofitVersion"</span></span><br><span class="line"><span class="function">    compile "com.squareup.retrofit2:retrofit-mock:$rootProject.retrofitVersion"</span></span><br><span class="line"><span class="function">    compile "com.github.franmontiel:PersistentCookieJar:$rootProject.cookieVersion"</span></span><br><span class="line"><span class="function">    <span class="comment">//稳定的</span></span></span><br><span class="line"><span class="function">    compile "com.github.bumptech.glide:glide:$rootProject.glideVersion"</span></span><br><span class="line"><span class="function">    compile "com.orhanobut:logger:$rootProject.loggerVersion"</span></span><br><span class="line"><span class="function">    compile "org.greenrobot:eventbus:$rootProject.eventbusVersion"</span></span><br><span class="line"><span class="function">    compile "com.google.code.gson:gson:$rootProject.gsonVersion"</span></span><br><span class="line"><span class="function">    <span class="comment">//不稳定的</span></span></span><br><span class="line"><span class="function">    compile "com.github.mzule.activityrouter:activityrouter:$rootProject.routerVersion"</span></span><br><span class="line"><span class="function">    compile "com.jude:easyrecyclerview:$rootProject.easyRecyclerVersion"&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样我们修改compileSdkVersion、buildToolsVersion、defaultConfig的值或者依赖库文件的版本号都可以直接在项目的build.gradle文件中直接修改了，修改完后整个项目也就都改过来了。</p>
<h3 id="5-第五步：跨Module跳转问题"><a href="#5-第五步：跨Module跳转问题" class="headerlink" title="5.第五步：跨Module跳转问题"></a>5.第五步：跨Module跳转问题</h3><blockquote>
<p>在组件化开发的时候，我们不能在使用显示调用来跳转页面了，因为我们组件化的目的之一就是解决模块间的强依赖问题，组件跟组件之间完全没有任何依赖，假如现在我从A组件跳转到B组件，并且要携带参数跳转，这时候怎么办？</p>
</blockquote>
<p>这个时候可以引入“路由”的概念。关于路由，有很多开源的库，比如Arouter，ActivityRouter等，可以根据自己需要选择一个。</p>
<h3 id="6-第六步：Module之间通信问题"><a href="#6-第六步：Module之间通信问题" class="headerlink" title="6.第六步：Module之间通信问题"></a>6.第六步：Module之间通信问题</h3><p>如果在B组件中要通知A组件刷新列表，就要想办法解决组件间的通信问题，这个使用EventBus就能解决。</p>
<h3 id="7-资源名冲突问题"><a href="#7-资源名冲突问题" class="headerlink" title="7.资源名冲突问题"></a>7.资源名冲突问题</h3><p>因为我们拆分出了很多组件，在合并到主工程的时候就有可能会出现资源名冲突问题，比如A组件和B组件都定义了同一个资源名。这个可以在组件的build.gradle中添加如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resourcePrefix <span class="string">"组件名_"</span></span><br></pre></td></tr></table></figure>
<p>设置了这个属性后有个问题，所有的资源名必须以指定的字符串做前缀，否则会报错，而且resourcePrefix这个值只能限定xml里面的资源，并不能限定图片资源，所有图片资源仍然需要手动去修改资源名。其实最好还是团队开发中增加资源命名规约，只要遵守这个命名规约就能规避资源名冲突问题。</p>
<h2 id="组件化中可能会遇到的坑"><a href="#组件化中可能会遇到的坑" class="headerlink" title="组件化中可能会遇到的坑"></a>组件化中可能会遇到的坑</h2><h3 id="关于butterknife"><a href="#关于butterknife" class="headerlink" title="关于butterknife"></a>关于butterknife</h3><ul>
<li>butterknife在library activity中的使用和注意事项<ul>
<li>1、用R2代替R findviewid</li>
<li>2、在click方法中同样使用R2，但是找id的时候使用R。</li>
<li>3、特别注意library中switch-case的使用，在library中是不能使用switch- case 找id的，解决方法就是用if-else代替。</li>
</ul>
</li>
<li>为什么要用R2代替R，而不能直接用R？因为在library里R.id.xxx不再是final类型了，也就不是常量了变成可变的，而注入是需要传入常量。R2则是从主工程中复制了一份R过来给library使用。</li>
</ul>
<h3 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h3><h2 id="结言"><a href="#结言" class="headerlink" title="结言"></a>结言</h2><p>模块化是一个繁琐，枯燥，耗费时间长，通俗来说，时间和成果不成正比。进行模块化之前一定要思考是否项目真的需要，是不是单纯为了炫技。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/16/Android/项目组件化/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/16/Android/项目组件化/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/进程回收策略" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/13/Android/进程回收策略/" itemprop="url">
            <img src="https://whvn.cc/4959" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/13/Android/进程回收策略/">进程回收策略</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/13/Android/进程回收策略/">
            <time datetime="2017-08-13T08:22:11.000Z" itemprop="datePublished">2017-08-13</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="进程回收策略"><a href="#进程回收策略" class="headerlink" title="进程回收策略"></a>进程回收策略</h1><p>笔记参考自：<a href="https://yq.aliyun.com/articles/201636?utm_content=m_30411" target="_blank" rel="noopener">https://yq.aliyun.com/articles/201636?utm_content=m_30411</a></p>
<blockquote>
<p>LowMemoryKiller(低内存杀手)是Andorid基于oomKiller原理所扩展的一个多层次oomKiller，OOMkiller(Out Of Memory Killer)是在Linux系统无法分配新内存的时候，选择性杀掉进程，到oom的时候，系统可能已经不太稳定，而LowMemoryKiller是一种根据内存阈值级别触发的内存回收的机制，在系统可用内存较低时，就会选择性杀死进程的策略，相对OOMKiller，更加灵活。</p>
</blockquote>
<h1 id="OOMKiller"><a href="#OOMKiller" class="headerlink" title="OOMKiller"></a>OOMKiller</h1><blockquote>
<p>​    当我们启动应用时，需要向系统申请内存，即进行malloc的操作，进行malloc操作如果返回一个非NULL的操作表示申请到了可用的内存。事实上，这个地方是可能存在bug的。Linux有一种内存优化机制，即：允许程序申请比系统可用内存更多的内存（术语：overcommit），但是Linux并不保证这些内存马上可用，如果凑巧你申请到的内存中在你需要使用的时候还没有完全释放出来，这个时候就会触发OOM killer了。</p>
</blockquote>
<p>​    系统的物理内存往往是有限的，这就需要在使用过程中杀掉一些无用的进程以腾出新的内存。在Android系统中，AmS需要和Linux操作系统有个约定，即将要谈到的Linux内核的内存管理控制系统是如何通知AMS内存不足的。</p>
<p>​    Java虚拟机运行时都有各自独立的内存空间，应用程序A发生Out Of Memory并不意味着应用程序B也会发生Out Of Memory，很有可能仅仅是A程序用光了自己内存的上限，而系统内存却还是有的。所以说，单纯的AmS是无法获知系统内存是否低的。</p>
<p>​    Android系统如何知道系统内存低或者系统内存不够了？因为Android底层的Linux未采用磁盘虚拟内存机制，所以应用程序能够使用的内存大小完全取决于实际物理内存大小。</p>
<p>​    <img src="http://img.blog.csdn.net/20170911093523283?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>​    在Android中运行了一个OOM 进程，即Out Of Memory。该进程启动时会首先向Linux内核中把自己注册为一个OOM Killer，即当Linux内核的内存管理模块检测到系统内存低的时候就会通知已经注册的OOM进程，然后这些OOM Killer就可以根据各种规则进行内存释放了，当然也可以什么都不做。</p>
<p>​    Android中的OOM Killer进程是仅仅适用于Android应用程序的，该进程在运行时，AmS需要把每一个应用程序的oom_adj值告知给Killer。这个值的范围在－16到15，值越低，说明越重要，这个值类似于Linux系统中的进程nice值，只是在标准的Linux中，有其自己的一套Killer机制。</p>
<h1 id="LowMemoryKiller"><a href="#LowMemoryKiller" class="headerlink" title="LowMemoryKiller"></a>LowMemoryKiller</h1><p>在理解OOMKiller的时候注意两点：</p>
<ol>
<li><strong>LowMemoryKiller是被动杀死进程；</strong></li>
<li><strong>Android应用通过AMS，利用proc文件系统更新进程信息。</strong></li>
</ol>
<h2 id="Android-优先级更新"><a href="#Android-优先级更新" class="headerlink" title="Android 优先级更新"></a>Android 优先级更新</h2><blockquote>
<p>​    APP中很多操作都可能会影响进程列表的优先级，比如退到后台、移到前台等，都会潜在的影响进程的优先级，我们知道Lowmemorykiller是通过遍历内核的进程结构体队列，选择优先级低的杀死，那么APP操作是如何写入到内核空间的呢？Linxu有用户间跟内核空间的区分，无论是APP还是系统服务，都是运行在用户空间，严格说用户控件的操作是无法直接影响内核空间的，更不用说更改进程的优先级。</p>
</blockquote>
<p>​    其实这里是通过了Linux中的一个proc文件体统，proc文件系统可以简单的看成是内核空间映射成用户可以操作的文件系统，当然不是所有进程都有权利操作，通过proc文件系统，用户空间的进程就能够修改内核空间的数据，比如修改进程的优先级。</p>
<p>​    在Android5.0之前的系统是AMS进程直接修改的，5.0之后，是修改优先级的操作被封装成了一个独立的服务-lmkd，lmkd服务位于用户空间，其作用层次同AMS、WMS类似，就是一个普通的系统服务。</p>
<p><strong>模拟一个场景，APP只有一个Activity，我们主动finish掉这个Activity，APP就回到了后台，这里要记住，虽然没有可用的Activity，但是APP本身是没哟死掉的，这就是所谓的热启动</strong></p>
<p>针对4.3系统的流程如下：</p>
<p><img src="http://img.blog.csdn.net/20170911110910100?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>针对5.0以上的系统，流程如下：</p>
<p><img src="http://img.blog.csdn.net/20170911111518785?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="LowMemoryKiller内核区块"><a href="#LowMemoryKiller内核区块" class="headerlink" title="LowMemoryKiller内核区块"></a>LowMemoryKiller内核区块</h2><blockquote>
<p>LomemoryKiller属于一个内核驱动模块，主要功能是：在系统内存不足的时候扫描进程队列，找到低优先级（也许说性价比低更合适）的进程并杀死，以达到释放内存的目的。</p>
</blockquote>
<p>LomemoryKiller是如何找到低优先级进程，并杀死的。管家代码就在lowmem_shrink函数里面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lowmem_shrink</span><span class="params">(<span class="keyword">int</span> nr_to_scan, gfp_t gfp_mask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    struct task_struct *p;</span><br><span class="line">    。。。</span><br><span class="line">    关键点<span class="number">1</span> 找到当前的内存对应的阈值</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; array_size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (other_free &lt; lowmem_minfree[i] &amp;&amp;</span><br><span class="line">            other_file &lt; lowmem_minfree[i]) &#123;</span><br><span class="line">            min_adj = lowmem_adj[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    。。。</span><br><span class="line">    关键点<span class="number">2</span> 找到优先级低于这个阈值的进程，并杀死</span><br><span class="line"></span><br><span class="line">    read_lock(&amp;tasklist_lock);</span><br><span class="line">    for_each_process(p) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;oomkilladj &lt; min_adj || !p-&gt;mm)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        tasksize = get_mm_rss(p-&gt;mm);</span><br><span class="line">        <span class="keyword">if</span> (tasksize &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (selected) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;oomkilladj &lt; selected-&gt;oomkilladj)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;oomkilladj == selected-&gt;oomkilladj &amp;&amp;</span><br><span class="line">                tasksize &lt;= selected_tasksize)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        selected = p;</span><br><span class="line">        selected_tasksize = tasksize;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(selected != NULL) &#123;</span><br><span class="line">        force_sig(SIGKILL, selected);</span><br><span class="line">        rem -= selected_tasksize;</span><br><span class="line">    &#125;</span><br><span class="line">    lowmem_print(<span class="number">4</span>, <span class="string">"lowmem_shrink %d, %x, return %d\n"</span>, nr_to_scan, gfp_mask, rem);</span><br><span class="line">    read_unlock(&amp;tasklist_lock);</span><br><span class="line">    <span class="keyword">return</span> rem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过给应用设置内存对应的阈值，通过Linux的中的信号量，发送SIGKILL信号直接将进程杀死。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/13/Android/进程回收策略/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/13/Android/进程回收策略/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/OKHttp" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/11/Android/OKHttp/" itemprop="url">
            <img src="https://whvn.cc/4902" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/11/Android/OKHttp/">OKHttp总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/11/Android/OKHttp/">
            <time datetime="2017-08-11T08:22:11.000Z" itemprop="datePublished">2017-08-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="OKHttp"><a href="#OKHttp" class="headerlink" title="OKHttp"></a>OKHttp</h1><h2 id="OKHttp是什么？"><a href="#OKHttp是什么？" class="headerlink" title="OKHttp是什么？"></a>OKHttp是什么？</h2><blockquote>
<p>是一个网络请求库。处理对网络的请求操作。</p>
</blockquote>
<p>它做了一些什么操作？（我将从一步步做出一个简易OKHttp的角度来阐述）</p>
<p>首先，先思考没有使用库的情况下，一般是如何进行网络请求的。</p>
<blockquote>
<p>接收用户的请求 -&gt; 发出请求 -&gt; 接收响应结果并返回给用户。</p>
</blockquote>
<p>这种是最简单的请求情况，但是实际上应用的网络请求比较复杂。因此库的存在就是能有效帮助用户解决网络请求中可能出现的问题以及扩展请求的功能提高请求速度等等。</p>
<p>而OKHttp这个库，就是通过分层设计方法，把请求的流程分为七层。而层次之间的联系通过拦截器和组成链来实现。而且提供了自定义拦截器，用户可以在请求流程中加入自己想要处理的逻辑。例如加入日志打印等。</p>
<p>在这七层中的处理的，都是根据上层传入的request请求来进行自己的处理包装，然后传递给下一层。而每一层的处理有所不同，但又层层依赖。这种代码的层次风格很适合维护和降低开发难度。</p>
<h3 id="拦截器层次结构"><a href="#拦截器层次结构" class="headerlink" title="拦截器层次结构"></a>拦截器层次结构</h3><p>假设没有拦截器去一层层包装request请求，可能就直接根据用户传进来的request直接进行连接请求数据了。但是用户的request可能并不是一个规范的http request请求，所以OKHttp会帮用户构建一个规范http request，比如添加一些头部信息，如Content-Length, Transfer-Encoding, User-Agent, Host, Connection, 和 Content-Type等等。除此之外，OKHttp的每一层都做了些什么？</p>
<ul>
<li>自定义应用拦截器<ul>
<li>在这一层用户可以扩展针对请求数据和返回数据进行处理，比如打印返回数据的日志</li>
</ul>
</li>
<li>重试/重定向应用拦截器<ul>
<li>在这一层准备好后面进行网络连接的一些资源，比如连接池资源等。还提供了进行重试和重定向功能，因为网络环境不稳定情况下，已建立的连接可能会变成不可用状态，所以在这里会进行重试连接。还有一种情况就是，服务器返回了重定向码，在这一层将会<strong>新建一个request重新走一遍整个链</strong></li>
</ul>
</li>
<li>应用转网络的桥接器<ul>
<li>在这里处理一些网络层特有的Header信息，比如Host属性。而Host属性包括Host、Connection的Keep-Alive、gzip透明压缩、User-Agent描述、Cookie策略等。</li>
</ul>
</li>
<li>缓存拦截器<ul>
<li>这一层主要是查询、存储和有效检查。存储，在走请求链获取Response时记录cache。查询，根据Request过滤，来查找Cache。有效性检查，判断Cache数据的各项指标是否达到条件。如果这层能查询到有效的cache，将会直接返回数据提高请求速度。</li>
</ul>
</li>
<li>连接拦截器<ul>
<li>到这一层为止，还没有进行真正的网络连接。它负责准备好请求、连接资源、传输工具、和连接，为连接前做好准备工作。</li>
</ul>
</li>
<li>自定义网络拦截器<ul>
<li>它和应用拦截器相比，它更能直接监测到在线网络请求的数据交换过程。更加适合做数据检测的自定义功能。可以在这层做的一些扩展有       一、<strong>模拟各种网络情况</strong>：断断续续的网络非常不好模拟，我们可以在网络拦截器层自由设定网络返回值和返回时间，辅助我们检查App在处理网络数据时的健壮性。 二、<strong>模拟数据辅助开发/测试</strong>：指向官网的地址重定向为指向开发测试网址，甚至直接mock返回数据，换掉在线数据，这样可以检测整个网络层的全部功能</li>
</ul>
</li>
<li>在线网络请求拦截器<ul>
<li>前面所有层，其实都是在为这一层做准备。真正进行连接，请求数据，返回数据的操作就在这一层</li>
</ul>
</li>
</ul>
<h3 id="如何有效管理请求"><a href="#如何有效管理请求" class="headerlink" title="如何有效管理请求"></a>如何有效管理请求</h3><blockquote>
<p>请求有同步请求、异步请求</p>
</blockquote>
<p>对直接思路就是直接放入Request中处理，但是OKHttp分出两个类来表示，拆分职责。分出一个类来对不同方式的请求进行管理。主要职责：</p>
<ol>
<li>存储外界不断传入的 <code>SyncCall</code> 和<code>AsyncCall</code>，如果用户想取消则可以遍历所有的 call 进行 cancel 操作;</li>
<li>对于 <code>SyncCall</code>，由于它是即时运行的，因此<code>Dispatcher</code> 只需要在 <code>SyncCall</code> 运行前存储进来，在运行结束后移除即可；</li>
<li>对于 <code>AsyncCall</code>，<code>Dispatcher</code> 首先启动一个 ExecutorService，不断取出 <code>AsyncCall</code> 去进行执行，然后，我们设置最多执行的 request 数量为 64，如果已经有 64 个 request 在执行中，那么就将这个 asyncCall 存入等待区。</li>
</ol>
<h3 id="如何确保多个队列之间能顺畅地调度"><a href="#如何确保多个队列之间能顺畅地调度" class="headerlink" title="如何确保多个队列之间能顺畅地调度"></a>如何确保多个队列之间能顺畅地调度</h3><blockquote>
<p>对于多线程情况下的队列调度，其实就是<strong>数据移动和失败阻塞</strong>的这两个问题。</p>
</blockquote>
<h3 id="做了哪些优化"><a href="#做了哪些优化" class="headerlink" title="做了哪些优化"></a>做了哪些优化</h3><p>OkHttp主要针对队列和线程池做了优化：</p>
<p><strong>循环数组</strong><br>因为Dispatcher中的三个队列需要频繁出栈和入栈，所以采用了性能良好的循环数组ArrayDeque管理队列。</p>
<p><strong>阻塞队列</strong></p>
<p>因为Dispatcher自己用队列管理了排队的请求，所以Dispatcher中的线程池其实不需要缓存队列，那么这个线程池的任务其实是尽快地把元素转交给线程池中的io线程，所以采用了容量为0的阻塞队列SynchronousQueue，SynchronousQueue与普通队列不同，不是数据等线程，而是线程等数据，这样每次向SynchronousQueue里传入数据时，都会立即交给一个线程执行，这样可以提高数据得到处理的速度</p>
<p><strong>控制线程数量</strong></p>
<p>因为线程本身也会消耗资源，所以每个线程池都需要控制线程数量，OkHttp的线程池更进一步，会针对每个Host主机的请求（避免全都卡死在某个Host上），分别控制线程数上限（5个），具体方法就是遍历所有runningAsyncCall队列中的每个Call，查询每个Call的Host，并做计数。</p>
<h2 id="我为什么要使用OKHttp？"><a href="#我为什么要使用OKHttp？" class="headerlink" title="我为什么要使用OKHttp？"></a>我为什么要使用OKHttp？</h2><ul>
<li>volley是一个<strong>简单的异步http库</strong>，仅此而已。缺点是不支持同步，这点会限制开发模式；不能post大数据，所以不适合用来上传文件。</li>
<li>android-async-http。它是封装的httpClient，而android平台不推荐用HttpClient了，所以这个库已经<strong>不适合android平台</strong>了。</li>
<li>okhttp是<strong>高性能</strong>的http库，支持同步、异步，而且实现了spdy、http2、websocket协议，api很简洁易用，和volley一样实现了http协议的缓存。picasso就是利用okhttp的缓存机制实现其文件缓存，实现的很优雅，很<strong>正确，</strong>反例就是UIL（universal image loader），自己做的文件缓存，而且不遵守http缓存机制。</li>
</ul>
<p>另一方面OKhttp还是用OKIO库，这个库相比原生IO更加高效：</p>
<ul>
<li>它对数据进行了分块处理，这样在大数据IO的时候可以以块为单位进行IO，这可以提高IO的吞吐率</li>
<li>它对这些数据块使用链表进行管理，这可以仅通过移动“指针”就进行数据的管理，而不用真正去处理数据，而且对扩容来说也十分方便</li>
<li>对闲置的块进行管理，通过一个块池（SegmentPool）的管理，避免系统GC和申请byte时的zero-fill</li>
<li>其他的还有一些小细节上的优化，比如如果你把一个UTF-8的String转为ByteString，ByteString会保留一份对原来String的引用，这样当你下次 需要decode这个String时，程序通过保留的引用直接返回对应的String，从而避免了转码过程</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/11/Android/OKHttp/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/11/Android/OKHttp/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/跨进程EventBus" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/11/Android/跨进程EventBus/" itemprop="url">
            <img src="https://whvn.cc/5697" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/11/Android/跨进程EventBus/">EventBus跨进程思考</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/11/Android/跨进程EventBus/">
            <time datetime="2017-08-11T08:22:11.000Z" itemprop="datePublished">2017-08-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="场景设想与分析"><a href="#场景设想与分析" class="headerlink" title="场景设想与分析"></a>场景设想与分析</h1><blockquote>
<p>如果项目业务有一种场景需要使用EventBus进行跨进程通信，要怎么做？可能你会这样做↓</p>
</blockquote>
<p>​    主进程中创建一个本地服务LocalService，子进程中床架一个远程服务RemoteService，通信之前，先从业务模块通过EventBus post一个Event到本地LocalService，本地Service通过ServiceConnection与RemoteService绑定，本地LocalService在ServiceConnection的连接上将AIDL接口封装为一个Messenger，通过Messenger向RemoteService发送Message，而Event就是被包裹在Message中的Bundle里。</p>
<p>这样的做法缺点在于：</p>
<ul>
<li>每个序列化的Object要放入Bundle中，Bundle对象再放入Message中，过程繁琐</li>
<li>每个Message都有what属性需要Handler在处理时判断</li>
<li>业务模块想要执行子进程的RemoteService的方法先通过EventBus post一个Object，在LocalService必须有相应的处理。</li>
<li>子进程中的RemoteService接收到了服务器发来的消息给业务模块，先要通过本地LocalService处理Message，再由EventBus把Message中的Object post出去</li>
</ul>
<h1 id="学习开源HermesEventBus思路"><a href="#学习开源HermesEventBus思路" class="headerlink" title="学习开源HermesEventBus思路"></a>学习开源HermesEventBus思路</h1><p>​    首先，区分出主进程和子进程。在做初始化工作的时候，在主进程中创建一个主进程服务作为注册，注销，发送事件等入口，通过注解记录下这个类的所有方法信息；在子进程做同样相似的工作，不同在于，在子进程中利用AIDL绑定了主进程中的Service与主进程通信，通信的载体可以是一个自己定义好的类。当完成绑定之后，在子进程中，通过代理获取主进程的服务来对子进程服务进行逐个登记。之后无论是子进程还是主进程，要进行发送事件，都通过主进程对子进程发送时间。</p>
<h1 id="小结几种跨进程方法"><a href="#小结几种跨进程方法" class="headerlink" title="小结几种跨进程方法"></a>小结几种跨进程方法</h1><ul>
<li>BroadCastReceiver 由于面向整个系统注册的广播，跨进程消耗较大，性能不能保证。</li>
<li>ContentProvider 支持跨进程数据共享</li>
<li>AIDL 客户端调用AIDL接口是同步并且带返回结果的，如果执行时间较长，客户端的调用线程会一直等待。服务端执行AIDL接口是异步的，支持所有基本类型、AIDL接口、Parcelable、List、Map等类型的参数，实现起来繁琐。</li>
<li>Messenger 本质是AIDL通信，客户端发送Message后不带返回结果，服务端接收到Message是通过一个线程的Handler轮询MessageQueue处理的，因此处理Message是在同一线程。</li>
<li>HermesEventBus 本质也是AIDL通信，不需要自己实现绑定Service，发送事件也是不带返回结果的，使用简单。</li>
<li>Binder机制 Android跨进程通信实现的核心，AIDL就是基于Binder机制实现的，其中transact方法是客户端向服务端发送消息，onTransact方法是客户端接收服务端的消息。</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/11/Android/跨进程EventBus/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/11/Android/跨进程EventBus/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/WebView总结" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/09/Android/WebView总结/" itemprop="url">
            <img src="https://whvn.cc/295490" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/09/Android/WebView总结/">WebView总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/09/Android/WebView总结/">
            <time datetime="2017-08-09T08:22:11.000Z" itemprop="datePublished">2017-08-09</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="WebView总结"><a href="#WebView总结" class="headerlink" title="WebView总结"></a>WebView总结</h1><h2 id="WebView的基本使用"><a href="#WebView的基本使用" class="headerlink" title="WebView的基本使用"></a>WebView的基本使用</h2><ul>
<li>权限</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> &lt;uses-permission android:name=<span class="string">"android.permission.INTERNET"</span> /&gt;</span><br><span class="line">&lt;!--另外附上一些可能会用到的权限：--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span><br><span class="line">&lt;!--获取网络状态权限（情景：WebView联网前，应检查当前网络状态）--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span>/&gt;</span><br><span class="line">&lt;!--通过WiFi或移动基站的方式获取用户错略的经纬度信息--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> /&gt;</span><br><span class="line">&lt;!--通过GPS芯片接收卫星的定位信息权限（情景：结合HTML5使用Geolocation API获取位置时）--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span><br><span class="line">&lt;!--读写存储权限（情景：拍照/选择图片，涉及图片读取、编辑、压缩等功能时）--&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>常用配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">WebSettings  mWebSetting = mWebView.getSettings();  <span class="comment">//获取WebSetting</span></span><br><span class="line">setJavaScriptEnabled(<span class="keyword">true</span>);<span class="comment">//让WebView支持JavaScript</span></span><br><span class="line">setDomStorageEnabled(<span class="keyword">true</span>);<span class="comment">//启用H5 DOM API （默认false）</span></span><br><span class="line">setDatabaseEnabled(<span class="keyword">true</span>);<span class="comment">//启用数据库api（默认false）可结合 setDatabasePath 设置路径</span></span><br><span class="line">setCacheMode(WebSettings.LOAD_DEFAULT)<span class="comment">//设置缓存模式</span></span><br><span class="line">setAppCacheEnabled(<span class="keyword">true</span>);<span class="comment">//启用应用缓存（默认false）可结合 setAppCachePath 设置缓存路径</span></span><br><span class="line">setAppCacheMaxSize()<span class="comment">//已过时，高版本API上，系统会自行分配</span></span><br><span class="line">setPluginsEnabled(<span class="keyword">true</span>);  <span class="comment">//设置插件支持</span></span><br><span class="line">setRenderPriority(RenderPriority.HIGH);  <span class="comment">//提高渲染的优先级</span></span><br><span class="line">setUseWideViewPort(<span class="keyword">true</span>);  <span class="comment">//将图片调整到适合webview的大小</span></span><br><span class="line">setLoadWithOverviewMode(<span class="keyword">true</span>); <span class="comment">// 缩放至屏幕的大小</span></span><br><span class="line">setSupportZoom(<span class="keyword">true</span>);  <span class="comment">//支持缩放，默认为true</span></span><br><span class="line">setBuiltInZoomControls(<span class="keyword">true</span>); <span class="comment">//设置内置的缩放控件（若SupportZoom为false，该设置项无效）</span></span><br><span class="line">setDisplayZoomControls(<span class="keyword">false</span>); <span class="comment">//隐藏原生的缩放控件</span></span><br><span class="line">setLayoutAlgorithm(LayoutAlgorithm.SINGLE_COLUMN); <span class="comment">//支持内容重新布局</span></span><br><span class="line">supportMultipleWindows();  <span class="comment">//支持多窗口</span></span><br><span class="line">setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);  <span class="comment">//关闭webview中缓存</span></span><br><span class="line">setAllowFileAccess(<span class="keyword">true</span>);  <span class="comment">//设置可以访问文件</span></span><br><span class="line">setNeedInitialFocus(<span class="keyword">true</span>); <span class="comment">//当webview调用requestFocus时为webview设置节点</span></span><br><span class="line">setJavaScriptCanOpenWindowsAutomatically(<span class="keyword">true</span>); <span class="comment">//支持通过JS打开新窗口</span></span><br><span class="line">setLoadsImagesAutomatically(<span class="keyword">true</span>);  <span class="comment">//自动加载图片</span></span><br><span class="line">setDefaultTextEncodingName(<span class="string">"utf-8"</span>);<span class="comment">//设置编码格式</span></span><br></pre></td></tr></table></figure>
<ul>
<li>加载页面的三种方式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//网页</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_NET = <span class="string">"http://www.google.com"</span>; <span class="comment">// 记得加 "http://"</span></span><br><span class="line"><span class="comment">//assets 中的 html 资源</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_LOCAL =<span class="string">"file:///android_asset/xxx.html路径"</span>; </span><br><span class="line"><span class="comment">//SD 卡中的 html 资源</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_SD_CARD =<span class="string">"content://com.android.htmlfileprovider/mnt/sdcard/xxx.html"</span>; </span><br><span class="line">mWebView.loadUrl(URL_NET);</span><br><span class="line">mWebView.loadUrl(URL_LOCAL);</span><br><span class="line">mWebView.loadUrl(URL_SD_CARD);</span><br></pre></td></tr></table></figure>
<h2 id="WebViewClient-amp-WebChromeClient"><a href="#WebViewClient-amp-WebChromeClient" class="headerlink" title="WebViewClient &amp; WebChromeClient"></a>WebViewClient &amp; WebChromeClient</h2><h3 id="WebViewClient主要用于帮助webview处理各种通知和请求时间"><a href="#WebViewClient主要用于帮助webview处理各种通知和请求时间" class="headerlink" title="WebViewClient主要用于帮助webview处理各种通知和请求时间"></a>WebViewClient主要用于帮助webview处理各种通知和请求时间</h3><ul>
<li>shouldOverrideUrlLoading 加载时调用，可捕获url</li>
<li>onPageStart 开始加载时调用</li>
<li>onPageFinish 加载完成时调用</li>
<li>onReceiveError 接收到错误信息时调用，通常用来处理404等加载错误， <strong>但是在低于API23时，该方法失效，可能是大于API23不再接受网页连接错误，而是WebView自身的错误</strong></li>
</ul>
<h3 id="WebChromeClient用于辅助WebView处理JS的对话框，网站图标，位置，加载进度等信息"><a href="#WebChromeClient用于辅助WebView处理JS的对话框，网站图标，位置，加载进度等信息" class="headerlink" title="WebChromeClient用于辅助WebView处理JS的对话框，网站图标，位置，加载进度等信息"></a>WebChromeClient用于辅助WebView处理JS的对话框，网站图标，位置，加载进度等信息</h3><ul>
<li>onProgressChanged 加载进度</li>
<li>onReceivedTitle、onReceivedIcon 获取网页标题和图标</li>
</ul>
<h2 id="WebView与JS的交互"><a href="#WebView与JS的交互" class="headerlink" title="WebView与JS的交互"></a>WebView与JS的交互</h2><blockquote>
<p>前提条件：setJavaScriptEnabled(true)</p>
</blockquote>
<ul>
<li><p>调用JS方法</p>
<p><strong>mWebView.loadUrl(“javascript: 方法名(‘“+参数+”‘)”);</strong></p>
</li>
<li><p>js调用android方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//使用方法</span></span><br><span class="line"> mWebView.addJavascriptInterface(MethodObject,<span class="string">"name"</span>);</span><br><span class="line"> <span class="comment">//还需要写一个方法类</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">MethodObject</span> <span class="keyword">extends</span> <span class="title">Object</span> </span>&#123;</span><br><span class="line">    <span class="comment">//无参函数，js中通过：var str = window.name.HtmlcallJava(); 获取到</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">HtmlcallJava</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Html call Java"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//有参函数，js中通过：window.jsObj.HtmlcallJava2("IT-homer blog");</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">HtmlcallJava2</span><span class="params">(<span class="keyword">final</span> String param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Html call Java : "</span> + param;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="WebView优化"><a href="#WebView优化" class="headerlink" title="WebView优化"></a>WebView优化</h2><h3 id="1-页面加载速度"><a href="#1-页面加载速度" class="headerlink" title="1.页面加载速度"></a>1.页面加载速度</h3><blockquote>
<p>影响页面加载速度的因素有非常多，每次加载的过程中都会有较多的网络请求，除了 web 页面自身的 URL 请求，还会有 web 页面外部引用的JS、CSS、字体、图片等等都是个独立的 http 请求。这些请求都是串行的，这些请求加上浏览器的解析、渲染时间就会导致 WebView 整体加载时间变长</p>
</blockquote>
<ul>
<li><h4 id="选择合适的-WebView-缓存（二次加载速度优化）"><a href="#选择合适的-WebView-缓存（二次加载速度优化）" class="headerlink" title="选择合适的 WebView 缓存（二次加载速度优化）"></a>选择合适的 WebView 缓存（二次加载速度优化）</h4><ul>
<li><p><strong>WebView缓存</strong>分为：页面缓存和数据缓存。<strong>页面缓存</strong>指加载网页时，对页面或资源数据的缓存（一般使用RE管理器进入目录： “/data/data/(packageName)/cache/org.chromium.android_webview“可看 ）。<strong>数据缓存</strong>又分为 AppCache 与 DOM Storage 。AppCache可以有选择地缓存我们所想要缓存的东西；DOM Storage 则是HTML5的一个缓存机制，常用于存储简单的表单数据</p>
</li>
<li><p>WebView的缓存模式</p>
<p>|     LOAD_CACHE_ONLY     |             不使用网络，只读取本地缓存数据              |<br>| :———————: | :————————————–: |<br>|      LOAD_DEFAULT       |        根据cache-control决定是否从网络上取数据        |<br>|    LOAD_CACHE_NORMAL    | API level 17中已经废弃, 从API level 11开始作用同LOAD_DEFAULT模式 |<br>|      LOAD_NO_CACHE      |              不使用缓存，只从网络获取数据              |<br>| LOAD_CACHE_ELSE_NETWORK |    只要本地有，无论是否过期，或者no-cache，都使用缓存中的数据     |</p>
<p>​</p>
</li>
</ul>
</li>
<li><p>缓存的数据转移到SD卡</p>
<p>重写Context 类中的getCacheDir方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState()))&#123;</span><br><span class="line">           File externalStorageDir = Environment.getExternalStorageDirectory();</span><br><span class="line">           <span class="keyword">if</span> (externalStorageDir != <span class="keyword">null</span>)&#123;</span><br><span class="line">               <span class="comment">// &#123;SD_PATH&#125;/Android/data/</span></span><br><span class="line">               extStorageAppBasePath = <span class="keyword">new</span> File(externalStorageDir.getAbsolutePath() +</span><br><span class="line">                       File.separator +<span class="string">"Android"</span> + File.separator + <span class="string">"data"</span>+File.separator + getPackageName());</span><br><span class="line">               Log.i(TAG,extStorageAppBasePath+<span class="string">"====="</span>);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (extStorageAppBasePath != <span class="keyword">null</span>)&#123;</span><br><span class="line">               extStorageAppCachePath = <span class="keyword">new</span> File(extStorageAppBasePath.getAbsolutePath()+File.separator + <span class="string">"webViewCache"</span>);</span><br><span class="line">               Log.d(<span class="string">"extStorageAppCachePath"</span>,<span class="string">"extStorageAppCachePath = "</span>+extStorageAppCachePath);</span><br><span class="line">               <span class="keyword">boolean</span> isCachePathAvailable = <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">if</span> (!extStorageAppCachePath.exists())&#123;</span><br><span class="line">                   isCachePathAvailable = extStorageAppCachePath.mkdirs();</span><br><span class="line">                   <span class="keyword">if</span> (!isCachePathAvailable)&#123;</span><br><span class="line">                       extStorageAppCachePath = <span class="keyword">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<pre><code>@Override
public File getCacheDir() {

    if (extStorageAppCachePath != null){
        return extStorageAppCachePath;
    }else{
        return super.getCacheDir();
    }
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ​</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- **资源预加载**（首次速度优化）</span><br><span class="line"></span><br><span class="line">&gt; 缓存技术，能优化二次启动 WebView 的加载速度，那首次加载 H5 页面的速度该怎么优化?一种思路就是外部依赖的 JS、CSS、图片等资源先提前在wifi环境下先预载好</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WebView mWebView = (WebView) findViewById(R.id.webview);</span><br><span class="line">mWebView.setWebViewClient(new WebViewClient() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public WebResourceResponse shouldInterceptRequest(WebView webView, final String url) &#123;</span><br><span class="line">                WebResourceResponse response = null;</span><br><span class="line">              	// 检查该资源是否已经提前下载完成。我采用的策略是在应用启动时，用户在 wifi 的网络环境下				// 提前下载 H5 页面需要的资源。</span><br><span class="line">                boolean resDown = JSHelper.isURLDownValid(url);</span><br><span class="line">                if (resDown) &#123;</span><br><span class="line">                    jsStr = JsjjJSHelper.getResInputStream(url);</span><br><span class="line">                    if (url.endsWith(&quot;.png&quot;)) &#123;</span><br><span class="line">                        response = getWebResourceResponse(url, &quot;image/png&quot;, &quot;.png&quot;);</span><br><span class="line">                    &#125; else if (url.endsWith(&quot;.gif&quot;)) &#123;</span><br><span class="line">                        response = getWebResourceResponse(url, &quot;image/gif&quot;, &quot;.gif&quot;);</span><br><span class="line">                    &#125; else if (url.endsWith(&quot;.jpg&quot;)) &#123;</span><br><span class="line">                        response = getWebResourceResponse(url, &quot;image/jepg&quot;, &quot;.jpg&quot;);</span><br><span class="line">                    &#125; else if (url.endsWith(&quot;.jepg&quot;)) &#123;</span><br><span class="line">                        response = getWebResourceResponse(url, &quot;image/jepg&quot;, &quot;.jepg&quot;);</span><br><span class="line">                    &#125; else if (url.endsWith(&quot;.js&quot;) &amp;&amp; jsStr != null) &#123;</span><br><span class="line">                        response = getWebResourceResponse(&quot;text/javascript&quot;, &quot;UTF-8&quot;, &quot;.js&quot;);</span><br><span class="line">                    &#125; else if (url.endsWith(&quot;.css&quot;) &amp;&amp; jsStr != null) &#123;</span><br><span class="line">                        response = getWebResourceResponse(&quot;text/css&quot;, &quot;UTF-8&quot;, &quot;.css&quot;);</span><br><span class="line">                    &#125; else if (url.endsWith(&quot;.html&quot;) &amp;&amp; jsStr != null) &#123;</span><br><span class="line">                        response = getWebResourceResponse(&quot;text/html&quot;, &quot;UTF-8&quot;, &quot;.html&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // 若 response 返回为 null , WebView 会自行请求网络加载资源。 </span><br><span class="line">                return response;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">private WebResourceResponse getWebResourceResponse(String url, String mime, String style) &#123;</span><br><span class="line">        WebResourceResponse response = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            response = new WebResourceResponse(mime, &quot;UTF-8&quot;, new FileInputStream(new File(getJSPath() + TPMD5.md5String(url) + style)));</span><br><span class="line">        &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public String getJsjjJSPath() &#123;</span><br><span class="line">        String splashTargetPath = JarEnv.sApplicationContext.getFilesDir().getPath() + &quot;/JS&quot;;</span><br><span class="line">        if (!TPFileSysUtil.isDirFileExist(splashTargetPath)) &#123;</span><br><span class="line">            TPFileSysUtil.createDir(splashTargetPath);</span><br><span class="line">        &#125;</span><br><span class="line">        return splashTargetPath + &quot;/&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JS 脚本本地化（首次加载优化）</p>
<blockquote>
<p>​比预加载更粗暴的优化方法是直接将常用的 JS 脚本本地化，直接打包放入 apk 中。比如 H5 页面获取用户信息，设置标题等通用方法，就可以直接写入一个 JS 文件，放入 asserts 文件夹，在 WebView 调用了onPageFinished() 方法后进行加载。但是，<strong>该 JS 文件中需要写入一个 JS 文件载入完毕的事件</strong></p>
</blockquote>
</li>
</ul>
<ul>
<li>使用第三方WebView内核</li>
</ul>
<blockquote>
<p>Android 4.4 版本 Google 使用了Chromium 替代 Webkit 作为 WebView 内核,<strong>但是我们可以使用腾讯集成的SDK，就可以使用X5内核了</strong>，更换第三方内核速度之后各方面速度都会有较大的提升</p>
</blockquote>
<h3 id="2-内存泄露-amp-amp-内存优化"><a href="#2-内存泄露-amp-amp-内存优化" class="headerlink" title="2.内存泄露&amp;&amp;内存优化"></a>2.内存泄露&amp;&amp;内存优化</h3><blockquote>
<p>​    WebView解析网页时会申请Native堆内存用于保存页面元素，当页面较复杂时会有很大的内存占用。为了打开新页面时，为了能快速回退，之前页面占用的内存也不会释放。有时浏览十几个网页，都会占用几百兆的内存。这样加载网页较多时，会导致系统不堪重负，最终强制关闭应用，也就是出现应用闪退或重启。</p>
<p>​    由于占用的都是Native堆内存，所以实际占用的内存大小不会显示在常用的DDMS Heap工具中（这里看到的只是Java虚拟机分配的内存，一般即使Native堆内存已经占用了几百兆，这里显示的还只是几兆或十几兆）。只有使用adb shell中的一些命令比如dumpsys meminfo 包名，或者在程序中使用Debug.getNativeHeapSize()才能看到。</p>
<p>​    由于WebView的一个BUG，即使它所在的Activity(或者Service)结束也就是onDestroy()之后，或者直接调用WebView.destroy()之后，它所占用这些内存也不会被释放。</p>
</blockquote>
<p><strong>解决这个问题最直接的方法是：把使用了WebView的Activity(或者Service)放在单独的进程里。然后在检测到应用占用内存过大有可能被系统干掉或者它所在的Activity(或者Service)结束后，调用System.exit(0)，主动Kill掉进程。由于系统的内存分配是以进程为准的，进程关闭后，系统会自动回收所有内存。</strong></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/09/Android/WebView总结/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/09/Android/WebView总结/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/Android的渲染机制" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/03/Android/Android的渲染机制/" itemprop="url">
            <img src="https://whvn.cc/349975" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/03/Android/Android的渲染机制/">Android的渲染机制</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/03/Android/Android的渲染机制/">
            <time datetime="2017-08-03T08:22:11.000Z" itemprop="datePublished">2017-08-03</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Android的渲染机制"><a href="#Android的渲染机制" class="headerlink" title="Android的渲染机制"></a>Android的渲染机制</h1><h2 id="知识储备"><a href="#知识储备" class="headerlink" title="知识储备"></a>知识储备</h2><ul>
<li><strong>CPU</strong> ：中央处理器,它集成了运算,缓冲,控制等单元,包括绘图功能.CPU将对象处理为多维图形,纹理</li>
<li><strong>GPU</strong> ： 一个类似于CPU的专门用来处理Graphics的处理器, 作用用来帮助加快栅格化操作。也具备缓存的数据</li>
<li><strong>OpenGL ES</strong> ： 手持嵌入式设备的3DAPI,跨平台的、功能完善的2D和3D图形应用程序接口API</li>
<li><strong>DisplayList</strong> ： 在Android把XML布局文件转换成GPU能够识别并绘制的对象。这个操作是在DisplayList的帮助下完成的。DisplayList持有所有将要交给GPU绘制到屏幕上的数据信息。</li>
<li><strong>栅格化</strong> ：是 将图片等矢量资源,转化为一格格像素点的像素图,显示到屏幕上,过程图如下.</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-4f17720d731bc5af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="栅格化操作"></p>
<ul>
<li><strong>垂直同步VSYNC</strong> : 让显卡的运算和显示器刷新率一致以稳定输出的画面质量。它告知GPU在载入新帧之前，要等待屏幕绘制完成前一帧。</li>
<li><strong>Refresh Rate</strong> ： 屏幕一秒内刷新屏幕的次数,由硬件决定,例如60Hz</li>
<li><strong>Frame Rate</strong> ： GPU一秒绘制操作的帧数,单位是30fps</li>
</ul>
<h2 id="渲染机制分析"><a href="#渲染机制分析" class="headerlink" title="渲染机制分析"></a>渲染机制分析</h2><h3 id="渲染流程线"><a href="#渲染流程线" class="headerlink" title="渲染流程线"></a>渲染流程线</h3><ul>
<li><p>UI对象</p>
</li>
<li><p>CPU处理为多维图形，纹理</p>
</li>
<li><p>通过OpenGL ES接口调用GPU</p>
</li>
<li><p>GPU对图进行光栅化</p>
</li>
<li><p>硬件时钟，垂直同步</p>
</li>
<li><p>投射到屏幕</p>
<p>流程如下图：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-0224bc9dde7b163e?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片名称"></p>
</li>
</ul>
<h3 id="渲染时间线"><a href="#渲染时间线" class="headerlink" title="渲染时间线"></a>渲染时间线</h3><ul>
<li>Android系统每隔16ms发出垂直信号，触发对UI的渲染，如果每次渲染成功，这样就能够达到流畅的画面所需要的60fps，这意味这计算渲染的大多数操作都必须在16ms内完成。</li>
</ul>
<h3 id="正常情况"><a href="#正常情况" class="headerlink" title="正常情况"></a>正常情况</h3><p><img src="http://upload-images.jianshu.io/upload_images/1848340-d5f27647c1cd1f99?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="正常情况"></p>
<h3 id="渲染超时，即超过16ms"><a href="#渲染超时，即超过16ms" class="headerlink" title="渲染超时，即超过16ms"></a>渲染超时，即超过16ms</h3><ul>
<li>当一帧画面渲染超过16ms的时候，垂直同步机制会让显示器硬件等待GPU完成栅格化渲染操作，这样会让一帧画面多停留16ms，甚至更多，这样就造成了画面卡顿的视觉效果。</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-ef60409448b8395e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="img"></p>
<h2 id="渲染时会出现的问题"><a href="#渲染时会出现的问题" class="headerlink" title="渲染时会出现的问题"></a>渲染时会出现的问题</h2><h3 id="GPU过度绘制"><a href="#GPU过度绘制" class="headerlink" title="GPU过度绘制"></a>GPU过度绘制</h3><blockquote>
<p>GPU的绘制过程,就跟刷墙一样,一层层的进行,16ms刷一次.这样就会造成,图层覆盖的现象,即无用的图层还被绘制在底层,造成不必要的浪费.</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-aec8de30bcbdd39c?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<h3 id="过度绘制查看工具"><a href="#过度绘制查看工具" class="headerlink" title="过度绘制查看工具"></a>过度绘制查看工具</h3><blockquote>
<p>在手机端的开发者选项里,有OverDraw监测工具,<strong>调试GPU过度绘制工具</strong>,<br>其中<strong>颜色代表渲染的图层情况,分别代表1层,2层,3层,4层覆盖.</strong></p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-66d89d7950737583?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<h2 id="计算渲染的耗时"><a href="#计算渲染的耗时" class="headerlink" title="计算渲染的耗时"></a>计算渲染的耗时</h2><ul>
<li>任何时候View中的绘制内容发生变化时，都会重新执行创建DisplayList，渲染DisplayList，更新到屏幕上等一系列操作。这个流程的表现性能取决于你的View的复杂程度，View的状态变化以及渲染管道的执行性能。</li>
</ul>
<ul>
<li>当View的大小发生改变，DisplayList就会重新创建，然后再渲染，而当View发生位移，则DisplayList不会重新创建，而是执行重新渲染的操作。</li>
</ul>
<ul>
<li>当View过于复杂，操作又过于复杂，就会计算渲染时间超过16ms，产生卡顿问题。</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-0fe5822404e7898d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="img"></p>
<h2 id="如何优化"><a href="#如何优化" class="headerlink" title="如何优化"></a>如何优化</h2><h3 id="Android系统本身的优化"><a href="#Android系统本身的优化" class="headerlink" title="Android系统本身的优化"></a>Android系统本身的优化</h3><p>在Android里面那些由主题所提供的资源，例如Bitmaps，Drawables都是一起打包到统一的Texture纹理当中，然后再传递到 GPU里面，这意味着每次你需要使用这些资源的时候，都是直接从纹理里面进行获取渲染的。</p>
<h3 id="程序员自身需要做的优化"><a href="#程序员自身需要做的优化" class="headerlink" title="程序员自身需要做的优化"></a>程序员自身需要做的优化</h3><blockquote>
<p>扁平化处理,防止过度绘制OverDraw</p>
</blockquote>
<h4 id="每个layout最外层的父容器是否需要？"><a href="#每个layout最外层的父容器是否需要？" class="headerlink" title="每个layout最外层的父容器是否需要？"></a>每个layout最外层的父容器是否需要？</h4><ul>
<li>多余的布局，比如LinearLayout等，会让GPU多渲染一层图，所以能省去就省去。</li>
</ul>
<h4 id="布局层级优化"><a href="#布局层级优化" class="headerlink" title="布局层级优化"></a>布局层级优化</h4><ul>
<li>查看自己的布局，深的层级，能减少层级的情况尽量减少。</li>
</ul>
<h4 id="Hierarchy-Viewer工具"><a href="#Hierarchy-Viewer工具" class="headerlink" title="Hierarchy Viewer工具"></a>Hierarchy Viewer工具</h4><p>这是查看耗时的工具和布局树的深度的工具</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1848340-a8d7fbfdceefcade?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<p>利用它，可以查看自己布局树，尽量减少树的深度，减少每个View的渲染时间</p>
<h4 id="图片选择"><a href="#图片选择" class="headerlink" title="图片选择"></a>图片选择</h4><p>Android界面能用png尽量用png。因为32位png颜色过度平滑且支持透明。jpg是像素化压缩过的图片，质量已经下降了，不适合再拿来做9path的按钮和平铺拉伸的空间。</p>
<p>对于颜色繁杂的，<strong>照片墙纸之类的图片（应用的启动画面喜欢搞这种），那用jpg是最好不过</strong>了，这种图片压缩前压缩后肉眼分辨几乎不计，如果保存成png体积将是jpg的几倍甚至几十倍，严重浪费体积。</p>
<h4 id="清理不必要的背景"><a href="#清理不必要的背景" class="headerlink" title="清理不必要的背景"></a>清理不必要的背景</h4><p><img src="http://upload-images.jianshu.io/upload_images/1848340-4685b8733b3f1239?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<h4 id="当背景无法避免，尽量使用Color-TRANSPARENT"><a href="#当背景无法避免，尽量使用Color-TRANSPARENT" class="headerlink" title="当背景无法避免，尽量使用Color.TRANSPARENT"></a>当背景无法避免，尽量使用Color.TRANSPARENT</h4><blockquote>
<p>因为透明色<code>Color.TRANSPARENT</code>是不会被渲染的,他是透明的.</p>
</blockquote>
<h4 id="优化自定义View的计算"><a href="#优化自定义View的计算" class="headerlink" title="优化自定义View的计算"></a>优化自定义View的计算</h4><p>View中的方法OnMeasure,OnLayout,OnDraw.在我们自定义View起到了决定作用,要学会研究其中的优化方法.</p>
<blockquote>
<p>比如学会裁剪掉View的覆盖部分,增加cpu的计算量,来优化GPU的渲染</p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/03/Android/Android的渲染机制/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/03/Android/Android的渲染机制/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Android/Amigo的替换DEX修复思路" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/08/01/Android/Amigo的替换DEX修复思路/" itemprop="url">
            <img src="https://whvn.cc/620963" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/01/Android/Amigo的替换DEX修复思路/">Amigo的替换DEX修复思路</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/01/Android/Amigo的替换DEX修复思路/">
            <time datetime="2017-08-01T08:22:11.000Z" itemprop="datePublished">2017-08-01</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Amigo的替换DEX修复思路"><a href="#Amigo的替换DEX修复思路" class="headerlink" title="Amigo的替换DEX修复思路"></a>Amigo的替换DEX修复思路</h1><h2 id="知识储备"><a href="#知识储备" class="headerlink" title="知识储备"></a>知识储备</h2><h3 id="Dex"><a href="#Dex" class="headerlink" title="Dex"></a>Dex</h3><blockquote>
<p>​    APP有自己的类，这些类保存在APK的dex文件里面，所以APP启动的时候，也会创建一个自己的ClassLoader实例，用于加载自己dex文件中的类。</p>
</blockquote>
<h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><blockquote>
<p>​    <strong>一个运行的Android应用至少有2个ClassLoader</strong>。</p>
</blockquote>
<p>​    一个是BootClassLoader（系统启动的时候创建的），另一个是PathClassLoader（应用启动时创建的，用于加载“/data/app/me.kaede.anroidclassloadersample-1/base.apk”里面的类）。</p>
<blockquote>
<p>android中加载类一般使用的是<code>PathClassLoader</code>和<code>DexClassLoader</code></p>
</blockquote>
<p>​    对于PathClassLoader，Android是使用这个类作为其系统类和应用类的加载器。并且对于这个类呢，只能去<strong>加载已经安装到Android系统中的apk文件</strong>。对于DexClassLoader，可以用来从.jar和.apk类型的文件内部加载classes.dex文件。可以用来执行非安装的程序代码。</p>
<blockquote>
<p>​    一个ClassLoader可以包含多个dex文件，每个dex文件是一个Element，多个dex文件排列成一个有序的数组dexElements，当找类的时候，会按顺序遍历dex文件，然后从当前遍历的dex文件中找类，如果找类则返回，如果找不到从下一个dex文件继续查找。(来自：<a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a" target="_blank" rel="noopener">安卓App热补丁动态修复技术介绍</a>)</p>
</blockquote>
<h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><h3 id="一、检查补丁包"><a href="#一、检查补丁包" class="headerlink" title="一、检查补丁包"></a>一、检查补丁包</h3><p>​    检查是否有补丁包，并且签名正确，如果正确，则通过检验校验和是否与之前的检验和相同，不同则为检测到新的补丁包。</p>
<h3 id="二、释放Apk"><a href="#二、释放Apk" class="headerlink" title="二、释放Apk"></a>二、释放Apk</h3><p>​    释放 Dex 到指定目录，即解压apk并且输出到指定目录</p>
<h3 id="三、加载、合并Dex"><a href="#三、加载、合并Dex" class="headerlink" title="三、加载、合并Dex"></a>三、加载、合并Dex</h3><p>​    将补丁包中每个 dex 对应的 Element 对象拿出来，之后组成新的 Element[]。</p>
<h3 id="四、替换"><a href="#四、替换" class="headerlink" title="四、替换"></a>四、替换</h3><p>​    通过反射注入到当前的ClassLoader,将现有的 Element[] 数组替换掉。</p>
<blockquote>
<p>​    在 QZone 的实现方案中，他们是通过将新的 dex 插到 Element[] 数组的第一个位置，这样就会先加载新的 dex ，微信的方案是下发一个 DiffDex，然后在运行时与旧的 dex 合成一个新的 dex。但是 Amigo 是下发一个完整的 dex直接替换掉了原来的 dex。与其他的方案相比，Amigo 因为直接替换原来的 dex ,兼容性更好，能够支持修复的方面也更多。</p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/08/01/Android/Amigo的替换DEX修复思路/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/08/01/Android/Amigo的替换DEX修复思路/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-计网/Cookie与Session的作用与原理" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/07/30/计网/Cookie与Session的作用与原理/" itemprop="url">
            <img src="https://whvn.cc/621759" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/30/计网/Cookie与Session的作用与原理/">Cookie与Session的作用与原理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/30/计网/Cookie与Session的作用与原理/">
            <time datetime="2017-07-30T04:26:11.000Z" itemprop="datePublished">2017-07-30</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/计网/">计网</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/计网/">计网</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Cookie与Session的作用与原理"><a href="#Cookie与Session的作用与原理" class="headerlink" title="Cookie与Session的作用与原理"></a>Cookie与Session的作用与原理</h1><p>一、Cookie详解</p>
<p>（1）简介</p>
<blockquote>
<p>因为HTTP协议是无状态的，即服务器不知道用户上一次做了什么，这严重阻碍了交互式Web应用程序的实现。在典型的网上购物场景中，用户浏览了几个页面，买了一盒饼干和两饮料。最后结帐时，由于HTTP的无状态性，不通过额外的手段，服务器并不知道用户到底买了什么。为了做到这点，就需要使用到Cookie了。服务器可以设置或读取Cookies中包含信息，借此维护用户跟服务器会话中的状态。</p>
<p>Cookie（复数形态：Cookies），是指某些网站为了辨别用户身份、进行session跟踪而储存在用户本地终端上的数据（通常经过加密）。</p>
<p>Cookie是由服务端生成的，发送给客户端（通常是浏览器）的。Cookie总是保存在客户端中，按在客户端中的存储位置，可分为内存Cookie和硬盘Cookie：</p>
<blockquote>
<p>内存Cookie由浏览器维护，保存在内存中，浏览器关闭后就消失了，其存在时间是短暂的。</p>
<p>硬盘Cookie保存在硬盘里，有一个过期时间，除非用户手工清理或到了过期时间，硬盘Cookie不会被删除，其存在时间是长期的。所以，按存在时间，可分为非持久Cookie和持久Cookie。</p>
</blockquote>
</blockquote>
<p>（2）工作原理</p>
<blockquote>
<p>1、创建Cookie</p>
<blockquote>
<p>当用户第一次浏览某个使用Cookie的网站时，该网站的服务器就进行如下工作：</p>
<p>①该用户生成一个唯一的识别码（Cookie id），创建一个Cookie对象；</p>
<p>②默认情况下它是一个会话级别的cookie，存储在浏览器的内存中，用户退出浏览器之后被删除。如果网站希望浏览器将该Cookie存储在磁盘上，则需要设置最大时效（maxAge），并给出一个以秒为单位的时间（将最大时效设为0则是命令浏览器删除该Cookie）；</p>
<p>③将Cookie放入到HTTP响应报头，将Cookie插入到一个 Set-Cookie HTTP请求报头中。</p>
<p>④发送该HTTP响应报文。</p>
</blockquote>
<p>2、设置存储Cookie</p>
<blockquote>
<p>浏览器收到该响应报文之后，根据报文头里的Set-Cookied特殊的指示，生成相应的Cookie，保存在客户端。该Cookie里面记录着用户当前的信息。</p>
</blockquote>
<p>3、发送Cookie</p>
<blockquote>
<p>当用户再次访问该网站时，浏览器首先检查所有存储的Cookies，如果某个存在该网站的Cookie（即该Cookie所声明的作用范围大于等于将要请求的资源），则把该cookie附在请求资源的HTTP请求头上发送给服务器。</p>
</blockquote>
<p>4、读取Cookie</p>
<blockquote>
<p> 服务器接收到用户的HTTP请求报文之后，从报文头获取到该用户的Cookie，从里面找到所需要的东西。</p>
</blockquote>
</blockquote>
<p>（3）作用</p>
<blockquote>
<p>Cookie的根本作用就是在客户端存储用户访问网站的一些信息。典型的应用有：</p>
<p>1、记住密码，下次自动登录。</p>
<p>2、购物车功能。</p>
<p>3、记录用户浏览数据，进行商品（广告）推荐。</p>
</blockquote>
<p>（4）缺陷</p>
<blockquote>
<p>①Cookie会被附加在每个HTTP请求中，所以无形中增加了流量。</p>
<p>②由于在HTTP请求中的Cookie是明文传递的，所以安全性成问题。（除非用HTTPS）</p>
<p>③Cookie的大小限制在4KB左右。对于复杂的存储需求来说是不够用的。</p>
</blockquote>
<p>二、Session详解</p>
<p>（1）简介</p>
<blockquote>
<p>Session代表服务器与浏览器的一次会话过程，这个过程是连续的，也可以时断时续的。Session是一种服务器端的机制，Session 对象用来存储特定用户会话所需的信息。</p>
<p>Session由服务端生成，保存在服务器的内存、缓存、硬盘或数据库中。</p>
</blockquote>
<p>（2）工作原理</p>
<blockquote>
<p>1、创建Session</p>
<blockquote>
<p>当用户访问到一个服务器，如果服务器启用Session，服务器就要为该用户创建一个SESSION，在创建这个SESSION的时候，服务器首先检查这个用户发来的请求里是否包含了一个SESSION ID，如果包含了一个SESSION ID则说明之前该用户已经登陆过并为此用户创建过SESSION，那服务器就按照这个SESSION ID把这个SESSION在服务器的内存中查找出来（如果查找不到，就有可能为他新创建一个），如果客户端请求里不包含有SESSION ID，则为该客户端创建一个SESSION并生成一个与此SESSION相关的SESSION ID。这个SESSION ID是唯一的、不重复的、不容易找到规律的字符串，这个SESSION ID将被在本次响应中返回到客户端保存，而保存这个SESSION ID的正是COOKIE，这样在交互过程中浏览器可以自动的按照规则把这个标识发送给服务器。 </p>
</blockquote>
<p>2、使用Session</p>
<blockquote>
<p>我们知道在IE中，我们可以在工具的Internet选项中把Cookie禁止，那么会不会出现把客户端的Cookie禁止了，那么SESSIONID就无法再用了呢？找了一些资料说明，可以有其他机制在COOKIE被禁止时仍然能够把Session id传递回服务器。</p>
<p>经常被使用的一种技术叫做URL重写，就是把Session id直接附加在URL路径的后面一种是作为URL路径的附加信息,表现形式为： </p>
<p><a href="http://…./xxx;jSession=ByOK3vjFD75aPnrF7C2HmdnV6QZcEbzWoWiBYEnLerjQ99zWpBng!-145788764；" target="_blank" rel="noopener">http://…./xxx;jSession=ByOK3vjFD75aPnrF7C2HmdnV6QZcEbzWoWiBYEnLerjQ99zWpBng!-145788764；</a> </p>
<p>另一种是作为查询字符串附加在URL后面，表现形式为： </p>
<p><a href="http://…../xxx?jSession=ByOK3vjFD75aPnrF7C2HmdnV6QZcEbzWoWiBYEnLerjQ99zWpBng!-145788764" target="_blank" rel="noopener">http://…../xxx?jSession=ByOK3vjFD75aPnrF7C2HmdnV6QZcEbzWoWiBYEnLerjQ99zWpBng!-145788764</a> </p>
<p>还有一种就是表单隐藏字段。就是服务器会自动修改表单，添加一个隐藏字段，以便在表单提交时能够把Session id传递回服务器。</p>
</blockquote>
</blockquote>
<p>（3）作用</p>
<blockquote>
<p>Session的根本作用就是在服务端存储用户和服务器会话的一些信息。典型的应用有：</p>
<p>1、判断用户是否登录。</p>
<p>2、购物车功能。</p>
</blockquote>
<p>三、Cookie和Session的区别</p>
<blockquote>
<p>1、存放位置不同</p>
<blockquote>
<p>Cookie保存在客户端，Session保存在服务端。</p>
</blockquote>
<p>2 、存取方式的不同</p>
<blockquote>
<p> Cookie中只能保管ASCII字符串，假如需求存取Unicode字符或者二进制数据，需求先进行编码。Cookie中也不能直接存取Java对象。若要存储略微复杂的信息，运用Cookie是比拟艰难的。 </p>
<p> 而Session中能够存取任何类型的数据，包括而不限于String、Integer、List、Map等。Session中也能够直接保管Java Bean乃至任何Java类，对象等，运用起来十分便当。能够把Session看做是一个Java容器类。 </p>
</blockquote>
<p>3、安全性（隐私策略）的不同 </p>
<blockquote>
<p>Cookie存储在浏览器中，对客户端是可见的，客户端的一些程序可能会窥探、复制以至修正Cookie中的内容。而Session存储在服务器上，对客户端是透明的，不存在敏感信息泄露的风险。 假如选用Cookie，比较好的方法是，敏感的信息如账号密码等尽量不要写到Cookie中。最好是像Google、Baidu那样将Cookie信息加密，提交到服务器后再进行解密，保证Cookie中的信息只要本人能读得懂。而假如选择Session就省事多了，反正是放在服务器上，Session里任何隐私都能够有效的保护。 </p>
</blockquote>
</blockquote>
<p>4、有效期上的不同 </p>
<blockquote>
<p>只需要设置Cookie的过期时间属性为一个很大很大的数字，Cookie就可以在浏览器保存很长时间。 由于Session依赖于名为JSESSIONID的Cookie，而Cookie JSESSIONID的过期时间默许为–1，只需关闭了浏览器（一次会话结束），该Session就会失效。</p>
</blockquote>
<p>5、对服务器造成的压力不同 </p>
<blockquote>
<p>Session是保管在服务器端的，每个用户都会产生一个Session。假如并发访问的用户十分多，会产生十分多的Session，耗费大量的内存。而Cookie保管在客户端，不占用服务器资源。假如并发阅读的用户十分多，Cookie是很好的选择。</p>
</blockquote>
<p>6、 跨域支持上的不同 </p>
<blockquote>
<p>Cookie支持跨域名访问，例如将domain属性设置为“.baidu.com”，则以“.baidu.com”为后缀的一切域名均能够访问该Cookie。跨域名Cookie如今被普遍用在网络中。而Session则不会支持跨域名访问。Session仅在他所在的域名内有效。 </p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/07/30/计网/Cookie与Session的作用与原理/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/07/30/计网/Cookie与Session的作用与原理/">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-计网/计网总结" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<a href="/2017/07/23/计网/计网总结/" itemprop="url">
            <img src="https://whvn.cc/442708" class="article-banner" />
        </a>
	



        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/07/23/计网/计网总结/">计网总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/07/23/计网/计网总结/">
            <time datetime="2017-07-23T04:26:11.000Z" itemprop="datePublished">2017-07-23</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/计网/">计网</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/计网/">计网</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="计网总结"><a href="#计网总结" class="headerlink" title="计网总结"></a>计网总结</h1><h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><h3 id="三个基本问题"><a href="#三个基本问题" class="headerlink" title="三个基本问题"></a>三个基本问题</h3><ul>
<li>封装成帧</li>
<li>透明传输</li>
<li>差错检测</li>
</ul>
<h3 id="PPP帧与Mac帧的区别"><a href="#PPP帧与Mac帧的区别" class="headerlink" title="PPP帧与Mac帧的区别"></a>PPP帧与Mac帧的区别</h3><blockquote>
<p>ppp属于广域网范畴，MAC是局域网范畴，按实际情况和环境就选用不同的协议，ppp支持的网络结构只能是点对点，mac支持多点对多点。</p>
<p>以太网中用mac，远程的话就用ppp（如ADSL拨号，就是基于ppp的）。</p>
<p>ppp是点到点协议  ,逻辑上相连的就一台设备，因此不需要寻址, 目标地址为广播地址, PPP中前6个字节就是目标地址。</p>
</blockquote>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><blockquote>
<p>提供主机间的逻辑通信</p>
</blockquote>
<h3 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h3><p>ARP是解决<strong>同一个局域网</strong>中主机或路由器IP地址到硬件地址的映射问题。</p>
<blockquote>
<p>每台主机都有一个ARP高速缓存，里面存放着一个从IP地址到硬件地址的映射表，并且动态更新</p>
</blockquote>
<p>步骤：</p>
<ul>
<li>ARP进程在局域网上广播发送一个ARP请求分组。（附带上自己的IP地址和硬件地址以及目的地址）</li>
<li>在局域网上所有主机上运行ARP进程都会收到这个ARP分组</li>
<li>主机B的IP地址和ARP请求分组中要查询的一致，就收下这个请求分组，并且向主机A发送ARP响应分组</li>
<li>主机A收到主机B的ARP响应分组后，在自己的ARP高速缓存中写入主机B的IP地址到硬件地址的映射</li>
</ul>
<h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h3><p>ICMP报文是装在IP数据报中的，作为其中的数据部分。</p>
<p>应用：</p>
<ul>
<li>ping</li>
<li>tracerouter</li>
</ul>
<h3 id="路由选择协议"><a href="#路由选择协议" class="headerlink" title="路由选择协议"></a>路由选择协议</h3><h4 id="内部网关协议IGP"><a href="#内部网关协议IGP" class="headerlink" title="内部网关协议IGP"></a>内部网关协议IGP</h4><p><strong>RIP</strong>：基于距离向量</p>
<p>优点：</p>
<ul>
<li>配置简单</li>
<li>开销小</li>
</ul>
<p>缺点</p>
<ul>
<li><strong>大量广播</strong>。RIP向所有邻居每隔30秒广播一次完整的路由表,将占用宝贵的带宽资源,在较慢的广域网链路上尤其有问题｡</li>
<li><strong>没有成本概念</strong>｡RIP没有网络延迟和链路成本的概念｡当采用RIP时,路由/转发的决定只是基于跳线,这样,很容易导致无法选择最佳路由｡例如,一条链路拥有较高的带宽,但是,跳数较多,从而不能被选择｡</li>
<li><strong>支持的网络规模有限</strong>｡由于RIP路由协议最多只支持16个步跳,当超过该跳数时,网络将认为无法到达｡因此,RIP只能适用于规模较少的网络｡</li>
</ul>
<p><strong>OSPF</strong>:最短路径优先</p>
<p>优点：</p>
<ul>
<li><strong>快速收敛</strong>｡OSPF是真正的LOOP- FREE(无路由自环)路由协议｡源自其算法本身——链路状态及最短路径树算法,OSPF收敛速度快,能够在最短的时间内将路由变化传递到整个自治系统｡</li>
<li><strong>区域划分</strong>｡提出区域(Area)划分的概念,将自治系统划分为不同区域后,通过区域之间的对路由信息的摘要,大大减少了需传递的路由信息数量,也使得路由信息不会随网络规模的扩大而急剧膨胀｡</li>
<li><strong>开销控制</strong>｡将协议自身的开销控制到最小｡用于发现和维护邻居关系的是定期发送的不含路由信息的hello报文,非常短小｡包含路由信息的报文是触发更新的机制,而且只有在路由变化时才会发送｡但为了增强协议的健壮性,每1800秒全部重发一次｡</li>
<li><strong>安全性高</strong>｡良好的安全性,OSPF支持基于接口的明文及MD5 验证｡</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>配置相对复杂</strong>｡由于网络区域划分和网络属性的复杂性,需要网络分析员有较高的网络知识水平才能配置和管理OSPF网络｡</li>
<li><strong>路由负载均衡能力较弱</strong>｡OSPF虽然能根据接口的速率､连接可靠性等信息,自动生成接口路由优先级,但在通往同一目的的不同优先级路由中,OSPF只选择优先级较高的转发,不同优先级的路由中,不能实现负载分担｡只有相同优先级的,才能达到负载均衡的目的</li>
</ul>
<h4 id="外部网关协议EGP"><a href="#外部网关协议EGP" class="headerlink" title="外部网关协议EGP"></a>外部网关协议EGP</h4><p><strong>BGP</strong></p>
<blockquote>
<p>高度抽象，把AS自治系统抽象成一个路由，它就是一个基于路径向量路由选择协议。每个AS系统会有一个或者多个路由器充当发言人，根据收到的路由信息拓扑出AS的树型结构连通图</p>
</blockquote>
<h3 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h3><h2 id="运输层"><a href="#运输层" class="headerlink" title="运输层"></a>运输层</h2><blockquote>
<p>提供应用进程间端到端的逻辑通信</p>
</blockquote>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><ul>
<li>无连接，不可靠，面向报文</li>
<li>无拥塞控制，支持一对一，一对多，多对多，多对一，首部开销小</li>
<li>检验和把首部和数据部分一起都检验</li>
</ul>
<h4 id="UDP丢包"><a href="#UDP丢包" class="headerlink" title="UDP丢包"></a>UDP丢包</h4><p><strong>丢包的主要原因</strong></p>
<ol>
<li>接收端处理时间过长导致丢包：调用recv方法接收端收到数据后，处理数据花了一些时间，处理完后再次调用recv方法，在这二次调用间隔里，发过来的包可能丢失。<strong>对于这种情况可以修改接收端，将包接收后存入一个缓冲区，然后迅速返回继续recv.</strong></li>
<li>发送的包较大，超过接受者缓存导致丢包：包超过mtu size数倍，几个大的udp包可能会超过接收者的缓冲，导致丢包</li>
<li>发送的包频率太快：虽然每个包的大小都小于mtu size 但是频率太快</li>
</ol>
<p><strong>解决方案</strong></p>
<ul>
<li>可以修改接收端，将包接收后存入一个缓冲区</li>
<li>对于超过缓存大小的包，可以选择直接接受</li>
<li>通过流量控制</li>
</ul>
<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><ul>
<li>面向连接，可靠</li>
<li>面向字节流</li>
<li>全双工通信</li>
</ul>
<h4 id="TCP粘包拆包"><a href="#TCP粘包拆包" class="headerlink" title="TCP粘包拆包"></a>TCP粘包拆包</h4><ul>
<li><strong>粘包拆包出现的原因</strong> ：  因为TCP面向字节流传输的，发送端需要等缓冲区满才发送出去，造成粘包。接收方不及时接收缓冲区的包，造成多个包接收    </li>
<li><strong>非工程性的解决方法</strong>：<ul>
<li>利用TCP提供了强制数据立即传送的操作指令push<br><strong>缺点</strong>：但它关闭了优化算法，降低了网络发送效率，影响应用程序的性能</li>
<li>精简接收进程工作量、提高接收进程优先级等措施，使其及时接收数据<br><strong>缺点</strong>：只能减少出现粘包的可能性，但并不能完全避免粘包。因为当发送频率较高时，或由于网络突发可能使某个时间段数据包到达接收方较快，接收方还是有可能来不及接收，从而导致粘包。</li>
<li>两次send函数之间添加 sleep函数<br><strong>缺点</strong>：会降低数据传输效率</li>
</ul>
</li>
<li><strong>工程型的解决方法</strong>：<ul>
<li>1.消息定长，例如每个报文的大小为固定长度200字节,如果不够，空位补空格；</li>
<li>2.在包尾增加回车换行符进行分割（模仿帧的设计方式）；</li>
<li>3.将消息分为消息头和消息体，消息头中包含表示消息总长度（或者消息体长度）的字段，通常设计思路是消息头的第一个字段用int来表示消息的总长度；（在pushsdk中使用此种方式利用了Netty中的LengthFieldBasedFrameDecoder解码器实现)</li>
<li>4.更复杂的应用层协议；</li>
<li>添加标志字段，在每次发送数据是添加标记字段：A： =&gt;size 标记数据长度的方式  B：特定标记字段标记数据的结尾（模仿帧的设计方式）＝&gt;结束符的方式</li>
<li>定义应用层的数据通讯协议 ：=&gt;如果数据按照一定的方式存储或着优加密的需求， 可以通过自己定制 数据通讯协议对数据封装，并实现自己的数据 封包｜ 拆包函数。</li>
</ul>
</li>
</ul>
<blockquote>
<p>为了解决TCP粘包拆包的问题，Netty默认提供了多种编码器来处理</p>
</blockquote>
<h4 id="根据MTU拆分成多个数据报"><a href="#根据MTU拆分成多个数据报" class="headerlink" title="根据MTU拆分成多个数据报"></a>根据MTU拆分成多个数据报</h4><p><a href="http://blog.csdn.net/yusiguyuan/article/details/22782943" target="_blank" rel="noopener">http://blog.csdn.net/yusiguyuan/article/details/22782943</a></p>
<p>（TCP层的分段和IP层的分片之间的关系 &amp; MTU和MSS之间的关系）</p>
<h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><p><img src="http://www.52im.net/data/attachment/forum/201605/02/132229ti2rqg2lpnik3ii1.jpg" alt="理论联系实际：Wireshark抓包分析TCP 3次握手、4次挥手过程_6.jpg"></p>
<p>在客户端和服务端都创建好传输控制模块TCB的条件下：</p>
<ul>
<li>客户端向服务端发出连接请求报文段</li>
</ul>
<ul>
<li>服务端接受到连接请求报文段后，同意建立连接就返回一个确认报文段</li>
<li>客户端的TCP客户进程收到确认后，还需要向服务端发出确认报文段</li>
</ul>
<blockquote>
<p>ps:<strong>传输控制模块TCB</strong>:存储了每一个连接中的一些重要信息，比如TCP连接表，重传队列指针，当前发送的序列号等等。</p>
</blockquote>
<p>为什么是三次握手？</p>
<blockquote>
<p><strong>为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误</strong></p>
</blockquote>
<p>会有这样的一种情况：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。<strong>本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。</strong>采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。”。<strong>主要目的防止server端一直等待，浪费资源。</strong></p>
<h4 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h4><p><img src="http://www.52im.net/data/attachment/forum/201605/02/132717xa86zoapkfmhmppz.jpg" alt="理论联系实际：Wireshark抓包分析TCP 3次握手、4次挥手过程_15.jpg"></p>
<ul>
<li>1.客户端发送连接释放报文段，并且停止发送数据，主动关闭TCP连接，然后进入等待状态，等待服务端的确认</li>
<li>2.服务端收到连接释放报文段之后，立即发送确认报文段，然后进入关闭等待状态。并且TCP服务器进程会通知高层应用进程。这个时候，客户端到服务端这个方向的连接就处于半关闭状态。</li>
<li>客户端收到确认报文段之后，等待服务端发出连接释放报文段</li>
<li>3.若服务端没有要向客户端发送的数据之后，应用进程会通知TCP释放连接。这个时候，服务端会发出连接释放报文段</li>
<li>4.客户端收到连接释放报文段之后，会返回一个确认报文段。然后自己进入时间等待状态，即等待一个时间才会最终进入关闭状态。<ul>
<li>为什么需要等待一个时间？<ul>
<li>一、为了保证客户端最后发送的一个报文段能够到达服务端</li>
<li>二、防止已失效的连接请求报文段出现在本连接中</li>
</ul>
</li>
</ul>
</li>
<li>服务端只要收到了客户端最后一次的确认报文段就会进入关闭状态，结束这次TCP连接</li>
</ul>
<p>为什么需要四次挥手？</p>
<blockquote>
<p><strong>确保数据能够完成传输</strong>。 假设服务端收到连接释放报文段之后马上就释放连接，那么服务端还存在数据需要发送给客户端的话，就不能保证这些数据能够发送到客户端身上。因此需要等待服务端把数据发送完之后，由服务端发起一条连接释放报文段，也就是第三次挥手，最后由客户端发起确认，也就是第四次挥手，因此需要四次挥手才能确保数据能够完成完整的传输。</p>
</blockquote>
<h4 id="可靠传输的实现"><a href="#可靠传输的实现" class="headerlink" title="可靠传输的实现"></a>可靠传输的实现</h4><p><a href="http://www.cnblogs.com/newwy/p/3238362.html" target="_blank" rel="noopener">TCP可靠传输的实现</a></p>
<blockquote>
<p>TCP为了提供可靠传输：</p>
<p>（1）首先，采用三次握手来建立TCP连接，四次握手来释放TCP连接，从而保证建立的传输信道是可靠的。</p>
<p>（2）其次，TCP采用了连续ARQ协议（回退N，Go-back-N；超时自动重传）来保证数据传输的正确性，使用滑动窗口协议来保证接方能够及时处理所接收到的数据，进行流量控制。</p>
<p>（3）最后，TCP使用<strong>慢开始</strong>、<strong>拥塞避免</strong>、<strong>快重传</strong>和<strong>快恢复</strong>来进行拥塞控制，避免网络拥塞。</p>
</blockquote>
<ul>
<li>以字节为单位的滑动窗口</li>
<li>缓存机制<ul>
<li>发送缓存用来暂时存放：<br>1.发送应用程序传送给发送方TCP准备的数据<br>2.TCP已发送但尚未收到确认的数据。</li>
<li>接收缓存用来暂时存放：<br>1.按序到达的，但尚未被接收应用程序读取的数据。<br>2.未按序到达的数据。</li>
</ul>
</li>
<li>超时重传的时间选择</li>
</ul>
<h4 id="TCP流量控制原理"><a href="#TCP流量控制原理" class="headerlink" title="TCP流量控制原理"></a>TCP流量控制原理</h4><p>   所谓流量控制就是让发送发送速率不要过快，让接收方来得及接收。利用滑动窗口机制就可以实施流量控制。</p>
<p>​         原理这就是<strong>运用TCP报文段中的窗口大小字段来控制，发送方的发送窗口不可以大于接收方发回的窗口大小。</strong></p>
<p>​         考虑一种特殊的情况，就是接收方若没有缓存足够使用，就会发送零窗口大小的报文，此时发送放将发送窗口设置为0，停止发送数据。之后接收方有足够的缓存，发送了非零窗口大小的报文，但是这个报文在中途丢失的，那么发送方的发送窗口就一直为零导致死锁。</p>
<p>​         解决这个问题，TCP为每一个连接设置一个持续计时器（persistence timer）。只要TCP的一方收到对方的零窗口通知<strong>，就启动该计时器，周期性的发送一个零窗口探测报文段。对方就在确认这个报文的时候给出现在的窗口大小（注意：</strong>TCP规定，即使设置为零窗口，也必须接收以下几种报文段：零窗口探测报文段、确认报文段和携带紧急数据的报文段）。</p>
<h4 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h4><p>慢开始和拥塞避免</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0112/214351_J88Z_1403215.png" alt="img"></p>
<p>ps：<br><strong>拥塞窗口</strong>：cwnd<strong>（Congestion Window)是</strong>发送端**根据自己估计的网络拥塞程度而设置的窗口值，是来自发送端的流量控制。</p>
<p>如果发现RTT在增大，Vegas就认为网络正在<em>发生拥塞</em></p>
<p>（1）<strong>慢开始原理</strong></p>
<p>​     1）当主机开始发送数据时，如果立即将较大的发送窗口的全部数据字节都注入到网络中，那么由于不清楚网络的情况，有可能引其网络拥塞</p>
<p>​     2）比较好的方法是试探一下，即从小到达逐渐增大发送端的拥塞控制窗口数值</p>
<p>​     3）通常在刚刚开始发送报文段时可先将拥塞窗口cwnd(拥塞窗口)设置为一个最大报文段的MSS的数值。在每收到一个对新报文段确认后，将拥塞窗口增加至多一个MSS的数值，当rwind（接收窗口）足够大的时候，为了防止拥塞窗口cwind的增长引起网络拥塞，还需要另外一个变量—慢开始门限ssthresh</p>
<p>（2）<strong>拥塞避免原理</strong></p>
<p>​    1）让拥塞窗口cwnd缓慢增大，每经过一个往返时间RTT就把发送方的拥塞窗口cwnd加1，而不是加倍。按线性规律缓慢增长。</p>
<blockquote>
<p>无论，在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞之后，就会把门限ssthresh设置为发送方发送窗口值的一半</p>
</blockquote>
<hr>
<p><strong>快重传和快恢复</strong></p>
<p><strong>快重传算法</strong>：在某些情况下更早的重传丢失的报文段（如果当发送端接收到三个重复的确认ACK时，则断定分组丢失，立即重传丢失的报文段，而不必等待重传计时器超时）。</p>
<p>例如：M1，M2，M3 —–&gt; M1,M3,缺失M2，则接收方向发送方持续发送M2重复确认，当发送方收到M2的三次重复确认，则认为M2报文丢失，启动快重传机制，重传数据，其他数据发送数据放入队列，待快重传结束后再正常传输。</p>
<p><strong>快恢复算法</strong>有以下两个要点：</p>
<p>​     1）当发送方连续收到接收方发来的三个重复确认时，就执行“乘法减小”算法，把慢开始门限减半，这是为了预防网络发生拥塞。</p>
<p>​     2）由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，而是把<strong>cwnd(拥塞窗口)</strong>值设置为慢开始门限减半后的值，然后开始执行拥塞避免算法<strong>，使拥塞窗口的线性增大</strong>。</p>
<blockquote>
<p> ps: <strong>超时重传</strong>是TCP协议保证数据可靠性的另一个重要机制，其原理是在发送某一个数据以后就开启一个计时器，在一定时间内如果没有得到发送的数据报的ACK报文，那么就重新发送数据，直到发送成功为止。</p>
</blockquote>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><blockquote>
<p>协议规定应用进程间标准</p>
</blockquote>
<h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><blockquote>
<p>域名解析成IP地址</p>
</blockquote>
<p>域名服务器间的查询</p>
<ul>
<li>迭代查询</li>
<li>递归查询</li>
</ul>
<p>域名服务器广泛使用高速缓存，减轻根域名服务器以及减少因特网上DNS查询报文数量</p>
<h3 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h3><p><strong>整体流程</strong>：主机A以广播形式发送报文，DHCP中继（通常是一个路由器）收到报文之后，以单播形式转发此报文给DHCP服务器，然后又通过中继回发提供报文给主机A。DHCP客户就可以使用被分配的IP地址，但是有一定的租用期</p>
<p>详细的工作步骤：</p>
<ul>
<li>DHCP服务器被动打开UDP端口67，等待客户端发送报文</li>
<li>DHCP客户从UDP端口68发送DHCP发现报文</li>
<li>凡是收到DHCP发现报文的DHCP服务器都发出DHCP提供报文（DHCP客户端可以收到多个DHCP提供报文）</li>
<li>DHCP从几个DHCP服务器中选择一个，并向选择的DHCP服务器发送DHCP请求报文</li>
<li>被选择的DHCP服务器发送确认报文。这个时候，DHCP客户就可以使用IP地址了。这是一种<strong>已绑定</strong>的状态，即DHCP客户的IP地址和硬件地址已经绑定了。这个时候DHCP客户就会根据服务器提供的租用期设置两个计时器，分别在0.5T和0.85T的时候，请求更新租用期。</li>
<li>租用期过了一半，DHCP就会发送请求报文要求更新租用期</li>
<li>DHCP服务器若同意，则发回确认报文，得到新的租用期，重新设置计时器</li>
<li>若不同意，则发回否认报文。这时DHCP客户必须立即停止使用原来的IP地址，然后重新申请新的IP地址。</li>
<li>若服务器不响应，则在0.85T的时候重新执行以上操作</li>
<li>DHCP客户可以随时提前终止服务器所提供的租用期，只需要发送释放报文即可。</li>
</ul>
<h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><blockquote>
<p>HTTP协议是无状态的，即同一个客户第二次访问同一个服务器上的页面的时候，服务器响应时间与第一次响应时间相同。</p>
</blockquote>
<p>HTTP请求报文是作为TCP三次握手的第三个报文的数据</p>
<h4 id="HTTP1-0"><a href="#HTTP1-0" class="headerlink" title="HTTP1.0"></a>HTTP1.0</h4><p>非持续连接：每次请求完就会关闭TCP连接</p>
<p>缺点：</p>
<ul>
<li>每请求一个文档就需要两倍RTT的开销。</li>
<li><strong>每一次建立新的TCP连接</strong>都要分配缓存和变量<ul>
<li>现在浏览器都提供了能够打开5-10个并行的TCP连接，每一个TCP连接处理一个客户请求</li>
</ul>
</li>
</ul>
<h4 id="HTTP1-1"><a href="#HTTP1-1" class="headerlink" title="HTTP1.1"></a>HTTP1.1</h4><p>使用持续连接：就是万维网服务器在发送响应后仍然在一段时间内保持这条连接，使同一个客户可以继续在这条连接上传送后续的HTTP报文</p>
<p>两种工作方式：</p>
<ul>
<li>非流水线方式<ul>
<li>特点：</li>
<li>客户收到前一个响应后才能发出下一个请求</li>
<li>缺点：</li>
<li>服务器在发送完一个对象后，TCP连接会空闲，浪费资源</li>
</ul>
</li>
<li>流水线方式<ul>
<li>特点：</li>
<li>客户收到HTTP响应报文之前就可以继续发送新的请求报文。</li>
<li>优点：</li>
<li>TCP连接的空闲时间减少</li>
</ul>
</li>
</ul>
<h4 id="两者区别"><a href="#两者区别" class="headerlink" title="两者区别"></a>两者区别</h4><p>（<a href="http://blog.csdn.net/forgotaboutgirl/article/details/6936982）" target="_blank" rel="noopener">http://blog.csdn.net/forgotaboutgirl/article/details/6936982）</a></p>
<ul>
<li>可扩展性</li>
<li>缓存</li>
<li>带宽优化</li>
<li>长连接</li>
<li>消息传递</li>
<li>Host头域</li>
<li>错误提示</li>
<li>内容协商</li>
</ul>
<h4 id="HTTP2-0"><a href="#HTTP2-0" class="headerlink" title="HTTP2.0"></a>HTTP2.0</h4><p><strong>多路复用</strong></p>
<p>HTTP2.0使用了多路复用的技术，做到同一个连接并发处理多个请求，而且并发请求的数量比HTTP1.1大了好几个数量级。</p>
<p>当然HTTP1.1也可以多建立几个TCP连接，来支持处理更多并发的请求，但是创建TCP连接本身也是有开销的。</p>
<p><strong>关于多路复用，可以稍微扯上NIO</strong></p>
<p><strong>数据压缩</strong></p>
<p>HTTP1.1不支持header数据的压缩，HTTP2.0使用HPACK算法对header的数据进行压缩，这样数据体积小了，在网络上传输就会更快。</p>
<h2 id="输入URL之后的网络操作"><a href="#输入URL之后的网络操作" class="headerlink" title="输入URL之后的网络操作"></a>输入URL之后的网络操作</h2><p>输入URL之后的网络操作：<a href="https://segmentfault.com/a/1190000006879700" target="_blank" rel="noopener">https://segmentfault.com/a/1190000006879700</a> </p>
<p>DNS解析过程中同时存在UDP和TCP请求：<a href="http://www.cnblogs.com/549294286/p/5172435.html" target="_blank" rel="noopener">http://www.cnblogs.com/549294286/p/5172435.html</a></p>
<ul>
<li>DNS解析<ul>
<li>可扯上为什么DNS解析过程中同时存在UDP和TCP请求</li>
<li>可扯上DNS优化，即缓存 ：浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存</li>
<li>可扯上DNS负载均衡，即DNS重定向。CDN技术就是利用DNS重定向技术的，</li>
</ul>
</li>
<li>建立TCP连接</li>
<li>发送HTTP请求</li>
<li>发送所需文件给客户端</li>
<li>释放连接</li>
<li>浏览器渲染WEB资源</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>

            
    
        <a href="https://kiddot.github.io/2017/07/23/计网/计网总结/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="https://kiddot.github.io/2017/07/23/计网/计网总结/">评论</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/08/19/Android/学习Binder/" class="thumbnail">
    
    
        <span style="background-image:url(https://whvn.cc/6596)" alt="学习Binder" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2017/08/19/Android/学习Binder/" class="title">学习Binder</a></p>
                            <p class="item-date"><time datetime="2017-08-19T02:25:11.000Z" itemprop="datePublished">2017-08-19</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/08/16/Android/项目组件化/" class="thumbnail">
    
    
        <span style="background-image:url(https://whvn.cc/6585)" alt="项目组件化流程" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2017/08/16/Android/项目组件化/" class="title">项目组件化流程</a></p>
                            <p class="item-date"><time datetime="2017-08-16T02:22:11.000Z" itemprop="datePublished">2017-08-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/08/13/Android/进程回收策略/" class="thumbnail">
    
    
        <span style="background-image:url(https://whvn.cc/4959)" alt="进程回收策略" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2017/08/13/Android/进程回收策略/" class="title">进程回收策略</a></p>
                            <p class="item-date"><time datetime="2017-08-13T08:22:11.000Z" itemprop="datePublished">2017-08-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/08/11/Android/OKHttp/" class="thumbnail">
    
    
        <span style="background-image:url(https://whvn.cc/4902)" alt="OKHttp总结" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2017/08/11/Android/OKHttp/" class="title">OKHttp总结</a></p>
                            <p class="item-date"><time datetime="2017-08-11T08:22:11.000Z" itemprop="datePublished">2017-08-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/08/11/Android/跨进程EventBus/" class="thumbnail">
    
    
        <span style="background-image:url(https://whvn.cc/5697)" alt="EventBus跨进程思考" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2017/08/11/Android/跨进程EventBus/" class="title">EventBus跨进程思考</a></p>
                            <p class="item-date"><time datetime="2017-08-11T08:22:11.000Z" itemprop="datePublished">2017-08-11</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java集合/">java集合</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计网/">计网</a><span class="category-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java集合/">java集合</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计网/">计网</a><span class="tag-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/java集合/" style="font-size: 10px;">java集合</a> <a href="/tags/jvm/" style="font-size: 20px;">jvm</a> <a href="/tags/并发/" style="font-size: 10px;">并发</a> <a href="/tags/计网/" style="font-size: 10px;">计网</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://blog.yvesluo.cc/">Yves</a>
                    </li>
                
                    <li>
                        <a href="https://cristianoro7.github.io/">cristianoro</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 kiddot<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = '';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'kiddy0916' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>